<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OMP-VI · Orbital Mission Planner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Familjen+Grotesk:wght@400;500;600&family=JetBrains+Mono:wght@300;400;500;600&display=swap');
:root{--bg:#04050a;--s0:#070910;--s1:#0c0f1a;--s2:#10141f;--bd:#141826;--bd2:#1c2236;
  --txt:#c0c4dc;--txt2:#525a78;--txt3:#2a2e42;
  --cy:#17d4e8;--am:#e8a017;--rd:#e84a3a;--gn:#3ae882;--pu:#8b6ef5;--bl:#4a90e8;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--txt);font-family:'Familjen Grotesk',sans-serif;font-size:12px;display:flex;flex-direction:column}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.02) 2px,rgba(0,0,0,.02) 4px)}
/* HEADER */
.hdr{height:36px;display:flex;align-items:stretch;border-bottom:1px solid var(--bd);background:var(--s0);flex-shrink:0}
.hbrand{display:flex;align-items:center;gap:9px;padding:0 14px;border-right:1px solid var(--bd)}
.hmark{width:22px;height:22px;border-radius:50%;border:1px solid rgba(23,212,232,.3);display:flex;align-items:center;justify-content:center;color:var(--cy);font-size:10px;box-shadow:0 0 7px rgba(23,212,232,.15)}
.htitle{font-family:'Instrument Serif',serif;font-size:.95rem}.hsub{font-family:'JetBrains Mono',monospace;font-size:6.5px;letter-spacing:.2em;text-transform:uppercase;color:var(--txt3)}
.htabs{display:flex;border-right:1px solid var(--bd)}
.htab{display:flex;align-items:center;padding:0 13px;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:var(--txt3);cursor:pointer;border-bottom:2px solid transparent;transition:.12s;user-select:none}
.htab:hover{color:var(--txt2)}.htab.on{color:var(--cy);border-bottom-color:var(--cy)}
.hright{margin-left:auto;display:flex;align-items:stretch}
.hind{display:flex;align-items:center;gap:4px;padding:0 12px;border-left:1px solid var(--bd);font-family:'JetBrains Mono',monospace;font-size:7.5px;color:var(--txt3)}
.hdot{width:4px;height:4px;border-radius:50%}
.hdot-g{background:var(--gn);box-shadow:0 0 4px var(--gn);animation:blink 2.5s ease-in-out infinite}
.hdot-a{background:var(--am);box-shadow:0 0 4px var(--am);animation:blink 1.9s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
/* BODY */
.app-body{display:flex;flex:1;min-height:0;overflow:hidden}
/* PANELS */
.panel{width:212px;flex-shrink:0;background:var(--s0);display:flex;flex-direction:column;overflow:hidden}
.panel.r{width:256px;border-left:1px solid var(--bd)}.panel.l{border-right:1px solid var(--bd)}
.ps{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px;scrollbar-width:thin;scrollbar-color:var(--bd2) transparent}
.ps::-webkit-scrollbar{width:3px}.ps::-webkit-scrollbar-thumb{background:var(--bd2)}
/* SECTION LABEL */
.sl{font-family:'JetBrains Mono',monospace;font-size:6.5px;letter-spacing:.22em;text-transform:uppercase;display:flex;align-items:center;gap:6px;margin:12px 0 6px;color:var(--txt3)}
.sl::after{content:'';flex:1;height:1px;background:var(--bd)}.sl:first-child{margin-top:0}
.sl.cy{color:var(--cy)}.sl.cy::after{background:rgba(23,212,232,.18)}
.sl.am{color:var(--am)}.sl.am::after{background:rgba(232,160,23,.18)}
.sl.pu{color:var(--pu)}.sl.pu::after{background:rgba(139,110,245,.18)}
.sl.gn{color:var(--gn)}.sl.gn::after{background:rgba(58,232,130,.18)}
.sl.rd{color:var(--rd)}.sl.rd::after{background:rgba(232,74,58,.18)}
/* FORM */
.fg{margin-bottom:6px}
.fl{font-size:9.5px;color:var(--txt2);margin-bottom:2px;display:block;font-family:'JetBrains Mono',monospace}
.fi{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:4px;padding:4px 7px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:10.5px;outline:none;transition:.12s;appearance:none}
.fi:focus{border-color:rgba(23,212,232,.4)}select.fi{cursor:pointer}
.rrow{display:flex;align-items:center;gap:5px}
.rrow input[type=range]{flex:1;accent-color:var(--cy);cursor:pointer;height:2px}
.rv{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--cy);min-width:46px;text-align:right;white-space:nowrap}
/* DATA ROWS */
.dr{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0;border-bottom:1px solid var(--bd)}
.dr:last-child{border-bottom:none}
.dk{font-size:10px;color:var(--txt2)}.dv{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--cy);text-align:right}
.dv.am{color:var(--am)}.dv.rd{color:var(--rd)}.dv.gn{color:var(--gn)}.dv.pu{color:var(--pu)}.dv.bl{color:var(--bl)}.dv.wh{color:var(--txt)}
/* PHASE BOX */
.phase{background:var(--s1);border:1px solid var(--bd);border-radius:5px;padding:7px 9px;margin-bottom:6px;position:relative;overflow:hidden}
.phase::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px}
.phase.s1::before{background:var(--am)}.phase.s2::before{background:var(--pu)}.phase.orb::before{background:var(--cy)}.phase.los::before{background:var(--rd)}.phase.dep::before{background:var(--cy)}.phase.crs::before{background:var(--am)}.phase.arr::before{background:var(--pu)}
.ph{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:.14em;text-transform:uppercase;margin-bottom:5px}
.phase.s1 .ph{color:var(--am)}.phase.s2 .ph{color:var(--pu)}.phase.orb .ph{color:var(--cy)}.phase.los .ph{color:var(--rd)}
.phase.dep .ph{color:var(--cy)}.phase.crs .ph{color:var(--am)}.phase.arr .ph{color:var(--pu)}
/* CHIP */
.fchip{background:var(--s2);border:1px solid var(--bd);border-radius:3px;padding:3px 6px;margin-bottom:5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txt3);line-height:1.7}
.fchip .fc{color:var(--cy)}.fchip .fa{color:var(--am)}.fchip .fp{color:var(--pu)}.fchip .fg_{color:var(--gn)}
/* ENERGY BAR */
.ebar{height:3px;background:var(--s2);border-radius:2px;overflow:hidden;margin:4px 0 2px}
.efill{height:100%;border-radius:2px;transition:width .35s}
/* BUTTON */
.btn{display:flex;align-items:center;justify-content:center;gap:5px;padding:5px 9px;border-radius:4px;border:1px solid;font-family:'JetBrains Mono',monospace;font-size:9.5px;cursor:pointer;transition:.12s;width:100%;margin-bottom:4px}
.btn-s{background:var(--s2);border-color:var(--bd);color:var(--txt2)}.btn-s:hover{border-color:var(--bd2);color:var(--txt)}
.btn-cy{background:rgba(23,212,232,.07);border-color:rgba(23,212,232,.3);color:var(--cy)}.btn-cy:hover{background:rgba(23,212,232,.14)}
/* VIEWPORTS */
.vpa{flex:1;min-width:0;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:1px;background:var(--bd);overflow:hidden}
.vpa.solo .vp{display:none}.vpa.solo .vp.active{display:block;grid-column:1/3;grid-row:1/3}
.vp{background:var(--bg);position:relative;overflow:hidden;min-height:0}
.vp canvas{width:100%;height:100%;display:block}
.vpbar{position:absolute;top:0;left:0;right:0;height:20px;display:flex;align-items:center;justify-content:space-between;padding:0 8px;background:rgba(4,5,10,.85);border-bottom:1px solid var(--bd);z-index:5}
.vpbar-l{display:flex;align-items:center;gap:7px;pointer-events:none}
.vpname{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:.16em;text-transform:uppercase;color:var(--txt3)}
.vpbadge{font-family:'JetBrains Mono',monospace;font-size:6.5px;padding:1px 4px;border-radius:2px;background:rgba(23,212,232,.08);border:1px solid rgba(23,212,232,.2);color:var(--cy)}
.vpbadge.am{background:rgba(232,160,23,.08);border-color:rgba(232,160,23,.2);color:var(--am)}
.vpbadge.gn{background:rgba(58,232,130,.08);border-color:rgba(58,232,130,.2);color:var(--gn)}
.vpbadge.pu{background:rgba(139,110,245,.08);border-color:rgba(139,110,245,.2);color:var(--pu)}
.vpbtn{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--txt3);cursor:pointer;padding:1px 5px;border-radius:2px;transition:.1s;user-select:none;border:1px solid transparent}
.vpbtn:hover{color:var(--txt2);border-color:var(--bd2)}
/* PROGRESS */
.pgov{position:absolute;inset:0;background:rgba(4,5,10,.78);display:none;flex-direction:column;align-items:center;justify-content:center;gap:9px;z-index:20}
.pgov.vis{display:flex}
.pgring{width:26px;height:26px;border:2px solid var(--bd2);border-top-color:var(--cy);border-radius:50%;animation:spin .65s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.pgmsg{font-family:'JetBrains Mono',monospace;font-size:8.5px;letter-spacing:.1em;color:var(--txt2)}
.pgbar-w{width:150px;height:2px;background:var(--bd2);border-radius:1px}
.pgbar{height:100%;background:var(--cy);border-radius:1px;width:0;transition:width .08s}
/* COLORBAR */
.cbar{position:absolute;right:8px;bottom:26px;width:14px;pointer-events:none;z-index:5}
.cbar canvas{display:block;border-radius:2px}
.cbar-lbls{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--txt2);margin-top:2px;line-height:2.1}
.cbar-unit{font-family:'JetBrains Mono',monospace;font-size:6.5px;color:var(--txt3);text-align:center;margin-top:2px}
/* TOOLTIP */
.tip{position:fixed;background:rgba(7,9,16,.94);border:1px solid var(--bd2);border-radius:4px;padding:5px 8px;pointer-events:none;z-index:100;display:none}
.tip.vis{display:block}
.tip-row{font-family:'JetBrains Mono',monospace;font-size:9px;line-height:1.75;color:var(--txt2)}
.tip-row b{color:var(--cy)}
/* SELECTED POINT */
.selpt{position:absolute;width:8px;height:8px;border:1.5px solid var(--am);border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:6;display:none}
.selpt.vis{display:block}
/* PK CONTROLS */
.pkctrl{position:absolute;bottom:26px;left:8px;background:rgba(7,9,16,.88);border:1px solid var(--bd);border-radius:4px;padding:6px 8px;z-index:5;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--txt2)}
.pkctrl input{background:var(--s2);border:1px solid var(--bd);border-radius:3px;padding:2px 5px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:9px;outline:none;width:52px}
/* STATUS BAR */
.sbar{height:19px;border-top:1px solid var(--bd);background:var(--s0);display:flex;align-items:center;padding:0 11px;gap:16px;flex-shrink:0}
.si{font-family:'JetBrains Mono',monospace;font-size:7.5px;color:var(--txt3);display:flex;align-items:center;gap:3px}
.si span{color:var(--txt2)}
/* Staging section */
.stage-box{background:var(--s1);border:1px solid var(--bd);border-radius:4px;padding:6px 8px;margin-bottom:6px;position:relative}
.stage-box::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;border-radius:2px 0 0 2px}
.stage-box.sb1::before{background:var(--am)}.stage-box.sb2::before{background:var(--pu)}.stage-box.sb3::before{background:var(--bl)}
.sb-hd{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:.14em;text-transform:uppercase;color:var(--txt3);margin-bottom:5px}
.stage-box.sb1 .sb-hd{color:var(--am)}.stage-box.sb2 .sb-hd{color:var(--pu)}.stage-box.sb3 .sb-hd{color:var(--bl)}
.ri{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:3px;padding:3px 6px;color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:10px;outline:none;margin-bottom:3px}
.ri:focus{border-color:rgba(23,212,232,.4)}
/* dv stacked bar */
.dvbar-wrap{height:14px;border-radius:3px;overflow:hidden;display:flex;margin:3px 0;background:var(--s2)}
.dvbar-seg{height:100%;transition:width .4s;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:7px;white-space:nowrap;overflow:hidden}
</style>
</head>
<body>
<header class="hdr">
  <div class="hbrand">
    <div class="hmark">⊙</div>
    <div><div class="htitle"><em>OMP-VI</em></div><div class="hsub">Orbital Mission Planner</div></div>
  </div>
  <div class="htabs">
    <div class="htab on" data-mode="hohmann">Hohmann · Lambert</div>
    <div class="htab" data-mode="ascent">Ascenso Orbital</div>
  </div>
  <div class="hright">
    <div class="hind"><div class="hdot hdot-g"></div>SOLVER ACTIVO</div>
    <div class="hind"><div class="hdot hdot-a"></div>T₀:
      <input type="date" id="inp-epoch" value="2026-01-01" style="background:transparent;border:none;color:var(--am);font-family:'JetBrains Mono',monospace;font-size:7.5px;outline:none;cursor:pointer;margin-left:4px">
    </div>
  </div>
</header>

<div class="app-body">
<!-- ════ LEFT PANEL ════ -->
<div class="panel l"><div class="ps">

  <!-- HOHMANN LEFT -->
  <div id="lp-hoh">
    <div class="sl cy">Misión</div>
    <div class="fg"><label class="fl">Origen</label>
      <select class="fi" id="sel-orig"><option value="earth">Tierra</option><option value="mars">Marte</option><option value="venus">Venus</option></select></div>
    <div class="fg"><label class="fl">Destino</label>
      <select class="fi" id="sel-dest"><option value="mars" selected>Marte</option><option value="venus">Venus</option><option value="jupiter">Júpiter</option><option value="mercury">Mercurio</option></select></div>
    <div class="sl am">Maniobras</div>
    <div class="fg"><label class="fl">Órbita parkeo (km)</label>
      <div class="rrow"><input type="range" id="r-hp" min="160" max="5000" step="10" value="400"><span class="rv" id="v-hp">400 km</span></div></div>
    <div class="fg"><label class="fl">Captura destino (km)</label>
      <div class="rrow"><input type="range" id="r-hc" min="100" max="50000" step="100" value="400"><span class="rv" id="v-hc">400 km</span></div></div>
    <div class="fchip">Δv_esc = √(<span class="fc">v∞²+2μ/r_p</span>) − √(<span class="fa">μ/r_p</span>)</div>
    <div class="sl">Nave</div>
    <div class="fg"><label class="fl">Masa seca m_f (kg)</label><input type="number" class="fi" id="inp-mf" value="5000" min="10"></div>
    <div class="fg"><label class="fl">Isp (s)</label>
      <div class="rrow"><input type="range" id="r-isp" min="250" max="10000" step="10" value="450"><span class="rv" id="v-isp">450 s</span></div></div>
    <div class="fg"><label class="fl">Fracción propelente</label>
      <div class="rrow"><input type="range" id="r-fp" min="0.05" max="0.93" step="0.01" value="0.65"><span class="rv" id="v-fp">65%</span></div></div>
    <div class="dr"><span class="dk">m₀ disponible</span><span class="dv" id="d-m0">—</span></div>
    <div class="dr"><span class="dk">Δv disponible</span><span class="dv gn" id="d-dvcap">—</span></div>
    <div class="sl">Simulación</div>
    <div class="fg"><label class="fl">Velocidad</label>
      <select class="fi" id="sel-spd"><option value="0">⏸ Pausado</option><option value="1">×1 día/s</option><option value="7" selected>×1 sem/s</option><option value="30">×1 mes/s</option><option value="365">×1 año/s</option></select></div>
    <button class="btn btn-s" id="btn-reset-hoh">↺ Reset cámaras</button>
  </div>

  <!-- ASCENT LEFT -->
  <div id="lp-asc" style="display:none">
    <div class="sl cy">Sitio de lanzamiento</div>
    <div class="fg"><label class="fl">Sitio</label>
      <select class="fi" id="asc-site">
        <option value="28.5">Cape Canaveral (28.5°N)</option>
        <option value="5.2">Kourou, Guyana (5.2°N)</option>
        <option value="-8.7">Alcântara, Brasil (2.3°S)</option>
        <option value="63.0">Plesetsk, Rusia (63°N)</option>
        <option value="31.2">Jiuquan, China (40.6°N)</option>
      </select></div>
    <div class="fg"><label class="fl">Azimut (°)</label>
      <div class="rrow"><input type="range" id="asc-az" min="0" max="360" step="1" value="90"><span class="rv" id="v-az">90°</span></div></div>

    <div class="sl am">Órbita objetivo</div>
    <div class="fg"><label class="fl">Altitud (km)</label>
      <div class="rrow"><input type="range" id="asc-htgt" min="200" max="2000" step="10" value="400"><span class="rv" id="v-htgt">400 km</span></div></div>
    <div class="fg"><label class="fl">Tipo</label>
      <select class="fi" id="asc-type">
        <option value="leo">LEO circular</option>
        <option value="sso">SSO (hel.-síncrona)</option>
        <option value="gto">GTO (transferencia GEO)</option>
      </select></div>
    <div class="dr"><span class="dk">v_circ objetivo</span><span class="dv cy" id="a-vcirc">—</span></div>
    <div class="dr"><span class="dk">Δv_orbital ref.</span><span class="dv am" id="a-dvref">—</span></div>

    <div class="sl pu">Etapa 1</div>
    <div class="stage-box sb1">
      <div class="sb-hd">ETAPA 1</div>
      <div class="fg"><label class="fl">Masa estructural (kg)</label><input type="number" class="ri fi" id="s1-ms" value="8500" min="100"></div>
      <div class="fg"><label class="fl">Masa propelente (kg)</label><input type="number" class="ri fi" id="s1-mp" value="95000" min="100"></div>
      <div class="fg"><label class="fl">Isp (s)</label><div class="rrow"><input type="range" id="s1-isp" min="220" max="380" step="5" value="280"><span class="rv" id="v-s1isp">280 s</span></div></div>
      <div class="fg"><label class="fl">Empuje (kN)</label><input type="number" class="ri fi" id="s1-thr" value="1500" min="10"></div>
    </div>
    <div class="sl">Etapa 2</div>
    <div class="stage-box sb2">
      <div class="sb-hd">ETAPA 2</div>
      <div class="fg"><label class="fl">Masa estructural (kg)</label><input type="number" class="ri fi" id="s2-ms" value="1800" min="100"></div>
      <div class="fg"><label class="fl">Masa propelente (kg)</label><input type="number" class="ri fi" id="s2-mp" value="18000" min="100"></div>
      <div class="fg"><label class="fl">Isp (s)</label><div class="rrow"><input type="range" id="s2-isp" min="280" max="500" step="5" value="350"><span class="rv" id="v-s2isp">350 s</span></div></div>
      <div class="fg"><label class="fl">Empuje (kN)</label><input type="number" class="ri fi" id="s2-thr" value="180" min="1"></div>
    </div>

    <div class="sl gn">Carga útil</div>
    <div class="fg"><label class="fl">Masa payload (kg)</label><input type="number" class="fi" id="asc-pay" value="3000" min="1"></div>

    <div class="sl">Aerodinámica</div>
    <div class="fg"><label class="fl">Cd (coef. arrastre)</label>
      <div class="rrow"><input type="range" id="asc-cd" min="0.1" max="1.0" step="0.05" value="0.3"><span class="rv" id="v-cd">0.30</span></div></div>
    <div class="fg"><label class="fl">Área de referencia (m²)</label>
      <div class="rrow"><input type="range" id="asc-ar" min="1" max="80" step="1" value="12"><span class="rv" id="v-ar">12 m²</span></div></div>
    <div class="fg"><label class="fl">Ángulo de pitch (°)</label>
      <div class="rrow"><input type="range" id="asc-kick" min="1" max="20" step="0.5" value="5"><span class="rv" id="v-kick">5°</span></div></div>

    <button class="btn btn-cy" id="btn-sim">▶ Simular trayectoria</button>
    <button class="btn btn-s" id="btn-reset-asc">↺ Reset cámaras</button>
  </div>

</div></div>

<!-- ════ VIEWPORTS ════ -->
<div class="vpa" id="vpa">

  <div class="vp" id="vp0">
    <div class="vpbar">
      <div class="vpbar-l">
        <span class="vpname" id="vp0-name">Sistema Solar · Eclíptica</span>
        <span class="vpbadge" id="vp0-badge">Kepler real</span>
      </div>
      <div style="display:flex;gap:4px">
        <span class="vpbtn" data-vi="0" data-a="solo">⤢</span>
        <span class="vpbtn" data-vi="0" data-a="reset">⟳</span>
      </div>
    </div>
    <canvas id="c0" style="cursor:grab"></canvas>
    <div class="tip" id="tip0"></div>
  </div>

  <div class="vp" id="vp1">
    <div class="vpbar">
      <div class="vpbar-l">
        <span class="vpname" id="vp1-name">Porkchop Plot</span>
        <span class="vpbadge" id="vp1-badge">C₃ km²/s²</span>
      </div>
      <div style="display:flex;gap:4px">
        <span class="vpbtn" id="vp1-extra-btn" style="display:none"></span>
        <span class="vpbtn" data-vi="1" data-a="solo">⤢</span>
        <span class="vpbtn" id="vp1-calc-btn">⟳ Calcular</span>
      </div>
    </div>
    <canvas id="c1" style="cursor:crosshair"></canvas>
    <div class="pgov" id="v1-prog"><div class="pgring"></div><div class="pgmsg" id="v1-msg">Calculando...</div><div class="pgbar-w"><div class="pgbar" id="v1-bar"></div></div></div>
    <div class="cbar" id="cbar-wrap"><canvas id="cbar-cv" width="14" height="120"></canvas><div class="cbar-lbls" id="cbar-lbls"></div><div class="cbar-unit" id="cbar-unit"></div></div>
    <div class="selpt" id="selpt"></div>
    <!-- HOH pk controls -->
    <div class="pkctrl" id="pk-ctrl-hoh">
      <div style="margin-bottom:3px">Rango salida / TOF máx.</div>
      <div style="display:flex;align-items:center;gap:4px">
        <input id="pk-span" type="number" value="780" min="60" max="2000"><span>d /</span>
        <input id="pk-tof" type="number" value="400" min="30" max="900"><span>d</span>
      </div>
    </div>
    <div class="tip" id="tip1"></div>
  </div>

  <div class="vp" id="vp2">
    <div class="vpbar">
      <div class="vpbar-l">
        <span class="vpname" id="vp2-name">Salida · Tierra</span>
        <span class="vpbadge" id="vp2-badge">Hipérbola escape · km</span>
      </div>
      <div style="display:flex;gap:4px">
        <span class="vpbtn" data-vi="2" data-a="solo">⤢</span>
        <span class="vpbtn" data-vi="2" data-a="reset">⟳</span>
      </div>
    </div>
    <canvas id="c2" style="cursor:grab"></canvas>
    <div class="tip" id="tip2"></div>
  </div>

  <div class="vp" id="vp3">
    <div class="vpbar">
      <div class="vpbar-l">
        <span class="vpname" id="vp3-name">Llegada · Marte</span>
        <span class="vpbadge" id="vp3-badge">Hipérbola captura · km</span>
      </div>
      <div style="display:flex;gap:4px">
        <span class="vpbtn" data-vi="3" data-a="solo">⤢</span>
        <span class="vpbtn" data-vi="3" data-a="reset">⟳</span>
      </div>
    </div>
    <canvas id="c3" style="cursor:grab"></canvas>
    <div class="tip" id="tip3"></div>
  </div>

</div><!-- /vpa -->

<!-- ════ RIGHT PANEL ════ -->
<div class="panel r"><div class="ps">

  <!-- HOHMANN RIGHT -->
  <div id="rp-hoh">
    <div class="sl cy">Misión seleccionada</div>
    <div class="dr"><span class="dk">Fecha salida</span><span class="dv" id="r-dep">—</span></div>
    <div class="dr"><span class="dk">Fecha llegada</span><span class="dv" id="r-arr">—</span></div>
    <div class="dr"><span class="dk">TOF</span><span class="dv am" id="r-tof">—</span></div>
    <div class="phase dep">
      <div class="ph">01 · Partida</div>
      <div class="dr"><span class="dk">v∞</span><span class="dv" id="r-vinf1">—</span></div>
      <div class="dr"><span class="dk">C₃</span><span class="dv bl" id="r-c3">—</span></div>
      <div class="dr"><span class="dk">Δv escape</span><span class="dv" id="r-dvesc">—</span></div>
      <div class="dr"><span class="dk">v_circ parkeo</span><span class="dv" id="r-vpark">—</span></div>
      <div class="dr"><span class="dk">e hipérbola</span><span class="dv" id="r-ehyp1">—</span></div>
    </div>
    <div class="phase crs">
      <div class="ph">02 · Crucero</div>
      <div class="dr"><span class="dk">a_t</span><span class="dv am" id="r-at">—</span></div>
      <div class="dr"><span class="dk">e_t</span><span class="dv am" id="r-et">—</span></div>
      <div class="dr"><span class="dk">v @ perihelio</span><span class="dv am" id="r-vper">—</span></div>
      <div class="dr"><span class="dk">v @ afelio</span><span class="dv am" id="r-vapo">—</span></div>
      <div class="dr"><span class="dk">Ángulo fase req.</span><span class="dv am" id="r-phase">—</span></div>
    </div>
    <div class="phase arr">
      <div class="ph">03 · Llegada</div>
      <div class="dr"><span class="dk">v∞</span><span class="dv pu" id="r-vinf2">—</span></div>
      <div class="dr"><span class="dk">Δv captura</span><span class="dv pu" id="r-dvcap2">—</span></div>
      <div class="dr"><span class="dk">Δv total</span><span class="dv rd" id="r-dvtot">—</span></div>
    </div>
    <div class="sl am">Balance de masa</div>
    <div class="dr"><span class="dk">m₀ requerida</span><span class="dv" id="r-m0r">—</span></div>
    <div class="dr"><span class="dk">Propelente</span><span class="dv rd" id="r-mpr">—</span></div>
    <div class="dr"><span class="dk">m₀ disponible</span><span class="dv wh" id="r-m0a">—</span></div>
    <div class="dr"><span class="dk">Margen Δv</span><span class="dv" id="r-margin">—</span></div>
    <div class="ebar"><div class="efill" id="efill" style="background:linear-gradient(90deg,var(--am),var(--rd))"></div></div>
    <div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:7.5px;color:var(--txt3);margin-bottom:4px"><span id="el">—</span><span id="er">—</span></div>
    <div class="sl">Energía orbital</div>
    <div class="dr"><span class="dk">ε específica</span><span class="dv" id="r-eps">—</span></div>
    <div class="dr"><span class="dk">TOF Hohm. (ref.)</span><span class="dv" id="r-period">—</span></div>
    <div class="dr"><span class="dk">r perihelio / afelio</span><span class="dv am" id="r-rpera">—</span></div>
  </div>

  <!-- ASCENT RIGHT -->
  <div id="rp-asc" style="display:none">
    <div class="sl cy">Resultado simulación</div>
    <div class="dr"><span class="dk">Estado</span><span class="dv gn" id="a-status">Sin simular</span></div>
    <div class="dr"><span class="dk">Tiempo total</span><span class="dv" id="a-ttime">—</span></div>
    <div class="dr"><span class="dk">Downrange final</span><span class="dv am" id="a-range">—</span></div>
    <div class="dr"><span class="dk">Altitud máx.</span><span class="dv cy" id="a-hmax">—</span></div>

    <div class="phase s1">
      <div class="ph">Etapa 1</div>
      <div class="dr"><span class="dk">Δv producida</span><span class="dv am" id="a-dv1">—</span></div>
      <div class="dr"><span class="dk">T/W (inicial)</span><span class="dv am" id="a-tw1">—</span></div>
      <div class="dr"><span class="dk">Δv disponible</span><span class="dv am" id="a-dvcap1">—</span></div>
      <div class="dr"><span class="dk">Max-Q (altitud)</span><span class="dv am" id="a-maxqh">—</span></div>
      <div class="dr"><span class="dk">q max</span><span class="dv rd" id="a-maxq">—</span></div>
    </div>
    <div class="phase s2">
      <div class="ph">Etapa 2</div>
      <div class="dr"><span class="dk">Δv producida</span><span class="dv pu" id="a-dv2">—</span></div>
      <div class="dr"><span class="dk">T/W (en separación)</span><span class="dv pu" id="a-tw2">—</span></div>
      <div class="dr"><span class="dk">Δv disponible</span><span class="dv pu" id="a-dvcap2">—</span></div>
    </div>
    <div class="phase orb">
      <div class="ph">Órbita conseguida</div>
      <div class="dr"><span class="dk">v horizontal</span><span class="dv cy" id="a-vfx">—</span></div>
      <div class="dr"><span class="dk">v vertical</span><span class="dv cy" id="a-vfy">—</span></div>
      <div class="dr"><span class="dk">v total</span><span class="dv cy" id="a-vtot">—</span></div>
      <div class="dr"><span class="dk">v_circ requerida</span><span class="dv" id="a-vcreq">—</span></div>
      <div class="dr"><span class="dk">Δv defecto/exceso</span><span class="dv" id="a-vdef">—</span></div>
    </div>
    <div class="phase los">
      <div class="ph">Pérdidas</div>
      <div class="dr"><span class="dk">Pérdida gravedad</span><span class="dv rd" id="a-gloss">—</span></div>
      <div class="dr"><span class="dk">Pérdida arrastre</span><span class="dv rd" id="a-dloss">—</span></div>
      <div class="dr"><span class="dk">Total pérdidas</span><span class="dv rd" id="a-tloss">—</span></div>
      <div class="dr"><span class="dk">Eficiencia (ΔvOrb/ΔvTot)</span><span class="dv gn" id="a-eff">—</span></div>
    </div>

    <div class="sl am">Balance de masa</div>
    <div class="dr"><span class="dk">Masa inicial total</span><span class="dv" id="a-m0">—</span></div>
    <div class="dr"><span class="dk">Masa en órbita</span><span class="dv gn" id="a-morb">—</span></div>
    <div class="dr"><span class="dk">Payload fraction</span><span class="dv cy" id="a-lambda">—</span></div>
    <div class="dr"><span class="dk">Fracción estructural 1</span><span class="dv am" id="a-eps1">—</span></div>
    <div class="dr"><span class="dk">Fracción estructural 2</span><span class="dv pu" id="a-eps2">—</span></div>

    <div class="sl">Balance Δv</div>
    <div class="fchip">Δv_total = <span class="fc">Δv_orb</span> + <span class="fa">Δv_grav</span> + <span class="fg_">Δv_drag</span></div>
    <div id="dvbar-outer" style="margin:4px 0">
      <div class="dvbar-wrap">
        <div class="dvbar-seg" id="dvb-orb" style="background:rgba(23,212,232,.7)"></div>
        <div class="dvbar-seg" id="dvb-grav" style="background:rgba(232,160,23,.7)"></div>
        <div class="dvbar-seg" id="dvb-drag" style="background:rgba(232,74,58,.7)"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--txt3);margin-top:2px">
        <span style="color:var(--cy)" id="dvb-orb-l">—</span>
        <span style="color:var(--am)" id="dvb-grav-l">—</span>
        <span style="color:var(--rd)" id="dvb-drag-l">—</span>
      </div>
    </div>
    <div class="dr"><span class="dk">Δv total misión</span><span class="dv rd" id="a-dvtot">—</span></div>
  </div>

</div></div>
</div><!-- /app-body -->

<div class="sbar">
  <div class="si">Modo: <span id="sb-mode">Hohmann</span></div>
  <div class="si" id="sb-info1">Origen: <span id="sb-or">Tierra</span></div>
  <div class="si" id="sb-info2">Destino: <span id="sb-de">Marte</span></div>
  <div class="si">Época: <span id="sb-ep">2026-01-01</span></div>
  <div class="si" id="sb-fps">FPS: <span>—</span></div>
  <div class="si" style="margin-left:auto">Drag: pan · Scroll: zoom · R: reset</div>
</div>
<script>
'use strict';
// ══ CONSTANTS ══════════════════════════════════════════════════
const TAU=2*Math.PI, G0=9.80665;
// Heliocentric
const AU=1.495978707e11, YR=365.25*86400, DAY=86400;
const MU_S=1.32712440018e20, MU_S_AU=4*Math.PI*Math.PI, AUyr=AU/YR;
// Geocentric
const R_E=6371e3, MU_E=3.986004418e14;

// ══ PLANET DATA ════════════════════════════════════════════════
const PL={
  mercury:{name:'Mercurio',a:.3871,e:.2056,T:87.97,  R:2.440e6,mu:2.203e13,soi:1.120e8,color:'#7898a8',L0:252.25*Math.PI/180},
  venus:  {name:'Venus',   a:.7233,e:.0068,T:224.70, R:6.052e6,mu:3.249e14,soi:6.162e8,color:'#c8a050',L0:181.98*Math.PI/180},
  earth:  {name:'Tierra',  a:1.000,e:.0167,T:365.25, R:6.371e6,mu:3.986e14,soi:9.244e8,color:'#2a6ac8',L0:100.46*Math.PI/180},
  mars:   {name:'Marte',   a:1.524,e:.0934,T:686.97, R:3.390e6,mu:4.283e13,soi:5.772e8,color:'#c04820',L0:355.45*Math.PI/180},
  jupiter:{name:'Júpiter', a:5.203,e:.0484,T:4332.6, R:6.991e7,mu:1.267e17,soi:4.822e10,color:'#c09858',L0:34.40*Math.PI/180},
};

// ══ KEPLER + PLANET STATE ══════════════════════════════════════
function kepler(M,e){M=((M%TAU)+TAU)%TAU;let E=M+e*Math.sin(M);for(let i=0;i<64;i++){const d=(M-E+e*Math.sin(E))/(1-e*Math.cos(E));E+=d;if(Math.abs(d)<1e-12)break;}return E;}
function planetState(key,t_yr){
  const p=PL[key],n=TAU/(p.T/365.25),M=p.L0+n*t_yr,E=kepler(M,p.e);
  const nu=2*Math.atan2(Math.sqrt(1+p.e)*Math.sin(E/2),Math.sqrt(1-p.e)*Math.cos(E/2));
  const r=p.a*(1-p.e*Math.cos(E)),pp=p.a*(1-p.e*p.e),sq=Math.sqrt(MU_S_AU/pp);
  return{x:r*Math.cos(nu),y:r*Math.sin(nu),vx:-sq*Math.sin(nu),vy:sq*(p.e+Math.cos(nu)),r};
}
function stC(z){if(Math.abs(z)<1e-8)return.5-z/24;const s=Math.sqrt(Math.abs(z));return z>0?(1-Math.cos(s))/z:(Math.cosh(s)-1)/(-z);}
function stS(z){if(Math.abs(z)<1e-8)return 1/6-z/120;const s=Math.sqrt(Math.abs(z));return z>0?(s-Math.sin(s))/(s*s*s):(Math.sinh(s)-s)/(s*s*s);}

// ══ LAMBERT SOLVER (universal variables, bisection-guaranteed) ═
function lambert(r1v,r2v,tof_d){
  const tof=tof_d/365.25;if(tof<1e-6)return null;
  const r1=Math.sqrt(r1v.x**2+r1v.y**2),r2=Math.sqrt(r2v.x**2+r2v.y**2);
  if(r1<1e-12||r2<1e-12)return null;
  const cnu=Math.max(-1,Math.min(1,(r1v.x*r2v.x+r1v.y*r2v.y)/(r1*r2)));
  const dnu=Math.acos(cnu);if(Math.sin(dnu)<0.003)return null;
  const A=Math.sin(dnu)*Math.sqrt(r1*r2/(1-cnu));
  function yFn(z){const C=stC(z);if(C<=0)return null;const v=r1+r2+A*(z*stS(z)-1)/Math.sqrt(C);return v>1e-12?v:null;}
  function F(z){const y=yFn(z);if(!y)return null;const C=stC(z);if(C<=0)return null;const chi=Math.sqrt(y/C);return(chi**3*stS(z)+A*Math.sqrt(y))/Math.sqrt(MU_S_AU)-tof;}
  const ZB=4*Math.PI**2-0.02;
  let za=-0.5;for(let d=0.5;d<60;d+=0.5){if(yFn(-d)===null){za=-(d-0.5);break;}za=-d;}
  const Fa=F(za),Fb=F(ZB);if(!Fa||!Fb)return null;
  if(Math.sign(Fa)===Math.sign(Fb)){const F0=F(0.01);if(!F0||Math.sign(F0)===Math.sign(Fb))return null;za=0.01;}
  let lo=za,hi=ZB,z=(za+ZB)*.5;
  for(let i=0;i<100;i++){const fz=F(z);if(!fz){z=(lo+hi)*.5;continue;}if(Math.abs(fz)<1e-10)break;
    const h=1e-5,fp=F(z+h),fm=F(z-h);
    if(fp&&fm){const df=(fp-fm)/(2*h);if(Math.abs(df)>1e-14){const zn=z-fz/df;if(zn>lo&&zn<hi){z=zn;continue;}}}
    if(fz>0)lo=z;else hi=z;z=(lo+hi)*.5;if(hi-lo<1e-11)break;}
  const y=yFn(z);if(!y)return null;
  const g=A*Math.sqrt(y/MU_S_AU);if(Math.abs(g)<1e-14)return null;
  const fc=1-y/r1,gd=1-y/r2;
  if(Math.abs(F(z)||1)>0.5)return null;
  return{v1:{x:(r2v.x-fc*r1v.x)/g,y:(r2v.y-fc*r1v.y)/g},v2:{x:(gd*r2v.x-r1v.x)/g,y:(gd*r2v.y-r1v.y)/g}};
}
function hyperbola(vi,mu,rp){
  if(vi<1||rp<=0)return null;
  const a=mu/(vi*vi),e=1+rp/a,vh=Math.sqrt(vi*vi+2*mu/rp),vc=Math.sqrt(mu/rp);
  return{a,e,dv:vh-vc,v_hyp:vh,v_circ:vc,r_p:rp,th_inf:Math.acos(-1/e)};
}
function rocketM0(dv,isp,mf){const mr=Math.exp(dv/(isp*G0));return{m0:mf*mr,mp:mf*(mr-1),mr};}
function rocketDv(m0,mf,isp){return isp*G0*Math.log(m0/mf);}
function epochYr(s){return(new Date(s+'T12:00:00Z')-new Date('2000-01-01T12:00:00Z'))/(365.25*DAY*1000);}
function yrToDate(yr){return new Date(new Date('2000-01-01T12:00:00Z').getTime()+yr*365.25*DAY*1000).toISOString().slice(0,10);}

// ══ ATMOSPHERE (ISA + exponential upper) ══════════════════════
function isaDensity(h){
  h=Math.max(0,h);if(h>500e3)return 0;
  const L=[[0,1.225,8434],[11e3,.3639,6341],[20e3,.0880,6882],[32e3,.0132,9070],[47e3,.00143,7922],[51e3,.000860,5800],[71e3,.0000640,5684],[86e3,.00000640,7500]];
  let l=L[0];for(let i=L.length-1;i>=0;i--){if(h>=L[i][0]){l=L[i];break;}}
  return l[1]*Math.exp(-(h-l[0])/l[2]);
}

// ══ ASCENT TRAJECTORY SIMULATION ══════════════════════════════
// Flat-Earth 2D: x=downrange [m], h=altitude [m], vx=horiz, vh=vert
// Gravity turn: pitch over follows velocity vector after kick
function simAscent(cfg){
  const{stages,m_pay,Cd,A_ref,kick_deg,h_tgt}=cfg;

  // Total initial mass
  let m0=m_pay;stages.forEach(s=>m0+=s.ms+s.mp);
  let m=m0, x=0, h=0, vx=0, vh=0.1;
  let t=0;
  const DT=0.5; // s
  const REC=[], EVENTS=[];
  let grav_loss=0, drag_loss=0;
  let si=0; // current stage
  let mp_left=stages[0].mp; // propellant left in current stage
  let kicked=false, kick_speed=50; // m/s at which kick occurs (after vertical rise)
  let hmax=0, maxQ=0, maxQ_h=0, dv_stage=[0,0,0];
  let thrust_total_ms=0;

  for(let iter=0;iter<8000&&si<=stages.length;iter++){
    const r=R_E+h, grav=MU_E/(r*r);
    const rho=isaDensity(h);
    const v=Math.sqrt(vx*vx+vh*vh);
    const v_circ_here=Math.sqrt(MU_E/r);

    // Check orbit achieved
    if(h>=h_tgt&&vx>v_circ_here*0.95){
      EVENTS.push({t,x,h,vx,vh,type:'orbit'});break;
    }
    if(h<-100&&t>5)break; // crashed

    // Thrust & staging
    let Tx=0,Tvh=0,mdot_=0;
    if(si<stages.length){
      const st=stages[si];
      const Thr=st.thrust;
      // Direction: vertical until kick_speed reached, then gravity turn
      let dirx,dirh;
      if(!kicked){
        if(vx<1e-4){dirx=0;dirh=1;} // pure vertical
        else{kicked=true;}
      }
      if(kicked){
        // Gravity turn: thrust along velocity vector
        // Add initial kick: tilt by kick_deg at start of gravity turn
        if(v>1){
          // Compute flight path angle from vertical
          const ang_v=Math.atan2(vx,vh); // angle from vertical
          // Drive toward gravity turn naturally
          dirx=vx/v; dirh=vh/v;
        } else {dirx=Math.sin(kick_deg*Math.PI/180);dirh=Math.cos(kick_deg*Math.PI/180);}
      }
      if(!kicked){dirx=0;dirh=1;}
      // Apply kick impulse at vh>kick_speed
      if(!kicked&&vh>kick_speed){
        kicked=true;
        // Initial kick: add horizontal velocity
        const krad=kick_deg*Math.PI/180;
        // Redistribute some vertical velocity to horizontal
        vx+=Math.sin(krad)*vh; vh*=Math.cos(krad);
        dirx=vx/Math.sqrt(vx*vx+vh*vh);dirh=vh/Math.sqrt(vx*vx+vh*vh);
      }

      mdot_=Thr/(st.isp*G0);
      if(mp_left>0){
        Tx=Thr*dirx; Tvh=Thr*dirh;
        mp_left-=mdot_*DT; m-=mdot_*DT;
        dv_stage[si]+=(Thr/m)*DT;
      }else{
        // Stage separation
        EVENTS.push({t,x,h,vx,vh,type:'sep',si});
        m-=stages[si].ms; // drop struct mass
        si++;
        if(si<stages.length)mp_left=stages[si].mp;
      }
    }

    // Drag (opposing velocity)
    const q=0.5*rho*v*v;
    const D=q*Cd*A_ref;
    if(v>0.01){
      const Dx=-D*vx/v, Dvh=-D*vh/v;
      if(Tvh>0||Tx>0) drag_loss+=D/m*DT;
      Tx+=Dx; Tvh+=Dvh;
    }

    // Gravity loss (component of gravity along thrust direction)
    if(Tvh>0||Tx>0) grav_loss+=grav*Math.abs(vh/Math.max(v,1))*DT;

    // Equations of motion
    const ax=Tx/m;
    const avh=Tvh/m - grav;
    vx+=ax*DT; vh+=avh*DT;
    x+=vx*DT; h+=vh*DT;
    t+=DT;
    if(h>hmax)hmax=h;
    if(q>maxQ){maxQ=q;maxQ_h=h;}

    // Record
    if(iter%4===0) REC.push({t,x,h:Math.max(0,h),vx,vh,m,q,si,kicked});
  }

  const v_fin=Math.sqrt(vx*vx+vh*vh);
  const v_circ_tgt=Math.sqrt(MU_E/(R_E+h_tgt));
  return{traj:REC,events:EVENTS,grav_loss,drag_loss,m0,m_pay,
    m_fin:m,hmax,maxQ,maxQ_h,vfx:vx,vfy:vh,v_fin,v_circ_tgt,
    t_total:t,x_final:x,dv1:dv_stage[0],dv2:dv_stage[1]||0};
}

// ══ ASCENT CARPET (payload fraction map) ══════════════════════
// X: target altitude (200–2000 km)
// Y: Stage 1 Isp (220–420 s)
// Z: Payload fraction λ (analytical, 2-stage)
const CARPET_RX=80, CARPET_RY=60;
let carpetData=null, carpetBusy=false;
const ALT_MIN=200, ALT_MAX=2000; // km
const ISP1_MIN=200, ISP1_MAX=450; // s

// Δv to orbit estimate (gravity + drag losses empirical)
function dvOrbit(h_km){
  const h=h_km*1e3;
  const vcirc=Math.sqrt(MU_E/(R_E+h));
  // Gravity loss ≈ 1200–1550 m/s for near-vertical launches (higher alt → slightly more)
  const grav=1250+h_km*0.05;
  // Drag loss ≈ 100–180 m/s
  const drag=150;
  return{vcirc, grav, drag, total:vcirc+grav+drag};
}

async function computeCarpet(s2_isp, eps1, eps2){
  if(carpetBusy)return; carpetBusy=true;
  const pg=document.getElementById('v1-prog'),bar=document.getElementById('v1-bar'),msg=document.getElementById('v1-msg');
  pg.classList.add('vis');
  const grid=new Float32Array(CARPET_RX*CARPET_RY).fill(NaN);
  for(let yi=0;yi<CARPET_RY;yi++){
    for(let xi=0;xi<CARPET_RX;xi++){
      const h_km=ALT_MIN+(xi/(CARPET_RX-1))*(ALT_MAX-ALT_MIN);
      const isp1=ISP1_MIN+(yi/(CARPET_RY-1))*(ISP1_MAX-ISP1_MIN);
      const{total:dvT,vcirc,grav,drag}=dvOrbit(h_km);
      // Optimal 2-stage Δv split (Lagrange): approximately equal per stage (simplification)
      // More accurate: weighted by Isp
      const w1=isp1/(isp1+s2_isp), w2=s2_isp/(isp1+s2_isp);
      const dv1=dvT*w1, dv2=dvT*w2;
      // Payload fraction per stage: λ_i = (1-εi)·exp(-Δvi/(Ispi·g0))
      const l1=(1-eps1)*Math.exp(-dv1/(isp1*G0));
      const l2=(1-eps2)*Math.exp(-dv2/(s2_isp*G0));
      const lambda=l1*l2*100; // percentage
      grid[yi*CARPET_RX+xi]=lambda>0&&lambda<100?lambda:NaN;
    }
    if(yi%5===0){bar.style.width=((yi/CARPET_RY)*100).toFixed(0)+'%';msg.textContent=`Carpet solver ${((yi/CARPET_RY)*100).toFixed(0)}%`;await new Promise(r=>setTimeout(r,0));}
  }
  carpetData={grid,RX:CARPET_RX,RY:CARPET_RY};
  bar.style.width='100%';
  await new Promise(r=>setTimeout(r,30));
  pg.classList.remove('vis');carpetBusy=false;
  vpCarpet.draw();
}
// ══ APP STATE ══════════════════════════════════════════════════
const ST={
  mode:'hohmann', // 'hohmann' | 'ascent'
  // Hohmann
  orig:'earth',dest:'mars',h_park:400e3,h_cap:400e3,
  m_dry:5000,isp:450,fp:0.65,
  epochYr:epochYr('2026-01-01'),simT:0,simSpd:7/365.25,sel:null,
  // Ascent
  asc_result:null, asc_sel_t:null, // selected time on trajectory
};

// ══ VIEWPORT BASE CLASS ════════════════════════════════════════
// Coordinate system: canvas_x = cx + wx*zoom + pan.x
//                    canvas_y = cy - wy*zoom + pan.y  (Y flipped, pan.y same direction as drag)
class VP{
  constructor(id,defZoom){
    this.cv=document.getElementById(id);this.ctx=this.cv.getContext('2d');
    this.DPR=Math.min(devicePixelRatio||1,2);this.W=1;this.H=1;this.cx=0;this.cy=0;
    this.zoom=defZoom;this.defZoom=defZoom;this.pan={x:0,y:0};
    this._drag=false;this._bind();
    new ResizeObserver(()=>this._resize()).observe(this.cv.parentElement);this._resize();
  }
  _resize(){const el=this.cv.parentElement;this.cv.width=el.clientWidth*this.DPR;this.cv.height=el.clientHeight*this.DPR;this.W=this.cv.width;this.H=this.cv.height;this.cx=this.W/2;this.cy=this.H/2;this.draw();}
  reset(){this.zoom=this.defZoom;this.pan={x:0,y:0};this.draw();}
  w2c(wx,wy){return{x:this.cx+wx*this.zoom+this.pan.x,y:this.cy-wy*this.zoom+this.pan.y};}
  c2w(sx,sy){return{x:(sx-this.cx-this.pan.x)/this.zoom,y:(this.cy+this.pan.y-sy)/this.zoom};}
  _bind(){
    const cv=this.cv;
    cv.addEventListener('mousedown',e=>{this._drag=true;});
    window.addEventListener('mouseup',()=>this._drag=false);
    window.addEventListener('mousemove',e=>{
      if(!this._drag||!cv.matches(':hover'))return;
      this.pan.x+=e.movementX*this.DPR;this.pan.y+=e.movementY*this.DPR;this.draw();
    });
    cv.addEventListener('wheel',e=>{
      e.preventDefault();const f=e.deltaY>0?0.9:1/0.9;
      const rect=cv.getBoundingClientRect();const mx=(e.clientX-rect.left)*this.DPR,my=(e.clientY-rect.top)*this.DPR;
      const wp=this.c2w(mx,my);this.zoom*=f;const np=this.w2c(wp.x,wp.y);this.pan.x+=mx-np.x;this.pan.y+=my-np.y;this.draw();
    },{passive:false});
    cv.addEventListener('mousemove',e=>{const rect=cv.getBoundingClientRect();this.onHover((e.clientX-rect.left)*this.DPR,(e.clientY-rect.top)*this.DPR,e.clientX,e.clientY);});
    cv.addEventListener('click',e=>{const rect=cv.getBoundingClientRect();this.onClick((e.clientX-rect.left)*this.DPR,(e.clientY-rect.top)*this.DPR,e.clientX,e.clientY);});
    document.addEventListener('keydown',e=>{if((e.key==='r'||e.key==='R')&&cv.matches(':hover'))this.reset();});
  }
  onHover(){}onClick(){}draw(){}
  bg(c='#04050a'){this.ctx.fillStyle=c;this.ctx.fillRect(0,0,this.W,this.H);}
  ln(x1,y1,x2,y2,col,lw=1,a=1,d=[]){const{ctx}=this;ctx.save();ctx.globalAlpha=a;ctx.strokeStyle=col;ctx.lineWidth=lw;if(d.length)ctx.setLineDash(d);ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.restore();}
  circ(x,y,r,sc,fc,lw=1,a=1,d=[]){const{ctx}=this;ctx.save();ctx.globalAlpha=a;ctx.beginPath();ctx.arc(x,y,r,0,TAU);if(fc){ctx.fillStyle=fc;ctx.fill();}if(sc){ctx.strokeStyle=sc;ctx.lineWidth=lw;if(d.length)ctx.setLineDash(d);ctx.stroke();}ctx.restore();}
  arr(x1,y1,x2,y2,col,lw=1.5,hs=7){const{ctx}=this,dx=x2-x1,dy=y2-y1,a=Math.atan2(dy,dx);ctx.save();ctx.strokeStyle=col;ctx.fillStyle=col;ctx.lineWidth=lw;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.beginPath();ctx.moveTo(x2,y2);ctx.lineTo(x2-hs*Math.cos(a-.42),y2-hs*Math.sin(a-.42));ctx.lineTo(x2-hs*Math.cos(a+.42),y2-hs*Math.sin(a+.42));ctx.closePath();ctx.fill();ctx.restore();}
  txt(s,x,y,col='#c0c4dc',sz=9,bg=true){const{ctx}=this;ctx.save();ctx.font=`${sz}px 'JetBrains Mono',monospace`;const m=ctx.measureText(s);if(bg){ctx.fillStyle='rgba(4,5,10,.78)';ctx.fillRect(x-1,y-sz,m.width+3,sz+3);}ctx.fillStyle=col;ctx.fillText(s,x,y);ctx.restore();}
  poly(pts,col,lw=1,a=1,d=[]){if(pts.length<2)return;const{ctx}=this;ctx.save();ctx.globalAlpha=a;ctx.strokeStyle=col;ctx.lineWidth=lw;if(d.length)ctx.setLineDash(d);ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);ctx.stroke();ctx.restore();}
  gradLine(pts,c0,c1,lw=1.5,a=1){if(pts.length<2)return;const{ctx}=this,p0=pts[0],p1=pts[pts.length-1];const g=ctx.createLinearGradient(p0.x,p0.y,p1.x,p1.y);g.addColorStop(0,c0);g.addColorStop(1,c1);ctx.save();ctx.globalAlpha=a;ctx.strokeStyle=g;ctx.lineWidth=lw;ctx.beginPath();ctx.moveTo(p0.x,p0.y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);ctx.stroke();ctx.restore();}
}

// ══════════════════════════════════════════════════════════════
// HOHMANN VPs (unchanged from omp-v)
// ══════════════════════════════════════════════════════════════
class SolarVP extends VP{
  constructor(){super('c0',48);}
  draw(){if(ST.mode!=='hohmann'){return;}this.bg();this._grid();this._orbits();this._transfer();this._planets();this._sun();this._hud();}
  _grid(){const{ctx,W,H,zoom}=this,O=this.w2c(0,0);ctx.save();ctx.setLineDash([2,7]);ctx.strokeStyle='rgba(20,24,38,.9)';ctx.lineWidth=.5;[.5,1,1.5,2,3,5,8].forEach(d=>{ctx.beginPath();ctx.arc(O.x,O.y,d*zoom,0,TAU);ctx.stroke();});ctx.restore();this.ln(0,O.y,W,O.y,'rgba(20,24,38,.6)',.4);this.ln(O.x,0,O.x,H,'rgba(20,24,38,.6)',.4);ctx.save();ctx.font='7.5px JetBrains Mono,monospace';ctx.fillStyle='rgba(42,46,66,.8)';[1,2,3,5].forEach(d=>{const p=this.w2c(d,0);if(p.x>0&&p.x<W)ctx.fillText(d+' AU',p.x+2,O.y-4);});ctx.restore();}
  _orbits(){Object.entries(PL).forEach(([k,p])=>{const isKey=k===ST.orig||k===ST.dest,N=300,pts=[];for(let i=0;i<=N;i++){const nu=i/N*TAU,r=p.a*(1-p.e*p.e)/(1+p.e*Math.cos(nu));pts.push(this.w2c(r*Math.cos(nu),r*Math.sin(nu)));}this.poly(pts,p.color,isKey?.9:.35,isKey?.7:.22);});}
  _transfer(){
    if(!ST.sel)return;const sel=ST.sel;
    const s1=planetState(ST.orig,ST.epochYr+sel.t_dep_d/365.25),s2=planetState(ST.dest,ST.epochYr+sel.t_arr_d/365.25);
    const lam=lambert({x:s1.x,y:s1.y},{x:s2.x,y:s2.y},sel.tof_d);if(!lam)return;
    const N=200,dt=sel.tof_d/365.25/N;let rx=s1.x,ry=s1.y,vx=lam.v1.x,vy=lam.v1.y;
    const pts=[this.w2c(rx,ry)];
    for(let i=0;i<N;i++){const r2=rx*rx+ry*ry,r3=r2**1.5,ax=-MU_S_AU*rx/r3,ay=-MU_S_AU*ry/r3;vx+=ax*dt;vy+=ay*dt;rx+=vx*dt;ry+=vy*dt;pts.push(this.w2c(rx,ry));}
    this.gradLine(pts,'rgba(23,212,232,.9)','rgba(139,110,245,.9)',1.6);this.gradLine(pts,'rgba(23,212,232,.12)','rgba(139,110,245,.12)',6);
    const p1=this.w2c(s1.x,s1.y),p2=this.w2c(s2.x,s2.y),t_=performance.now()/1000,pulse=1+.14*Math.sin(t_*2.8);
    this.circ(p1.x,p1.y,4,'#e8a017',null,1.5);this.circ(p1.x,p1.y,10*pulse,'#e8a017',null,.7,.15);
    this.circ(p2.x,p2.y,4,'#8b6ef5',null,1.5);this.circ(p2.x,p2.y,10*pulse,'#8b6ef5',null,.7,.15);
    const v1m=Math.sqrt(lam.v1.x**2+lam.v1.y**2)+1e-12,u1x=lam.v1.x/v1m,u1y=lam.v1.y/v1m;
    const L1=Math.min(35,Math.max(12,(sel.dv_esc||0)/250));
    this.arr(p1.x,p1.y,p1.x+u1x*L1,p1.y-u1y*L1,'#e84a3a',1.5,5);
    this.txt('Δv₁='+(sel.dv_esc/1e3).toFixed(3)+'km/s',p1.x+u1x*L1+3,p1.y-u1y*L1,'#e84a3a',8);
    const soi1=(PL[ST.orig].soi/AU)*this.zoom*20,soi2=(PL[ST.dest].soi/AU)*this.zoom*20;
    this.circ(p1.x,p1.y,soi1,'rgba(42,106,200,.45)',null,.7,1,[5,8]);this.circ(p2.x,p2.y,soi2,'rgba(192,72,32,.45)',null,.7,1,[5,8]);
    const mid=pts[Math.floor(pts.length/2)];this.txt('TOF: '+sel.tof_d.toFixed(0)+'d',mid.x+4,mid.y-5,'rgba(23,212,232,.8)',8);
  }
  _planets(){const t=ST.epochYr+ST.simT;Object.entries(PL).forEach(([k,p])=>{const s=planetState(k,t),pos=this.w2c(s.x,s.y);const R=Math.max(3,Math.min(11,Math.log10(p.R/1e5)*4+2)),isKey=k===ST.orig||k===ST.dest;this.circ(pos.x,pos.y,R+2,null,'rgba(0,0,0,.5)');this.circ(pos.x,pos.y,R,p.color,p.color,isKey?2:1,isKey?1:.8);if(isKey)this.circ(pos.x,pos.y,R*3,p.color,null,.5,.12);const va=Math.atan2(s.vy,s.vx);this.ln(pos.x,pos.y,pos.x+Math.cos(va)*(R+9),pos.y-Math.sin(va)*(R+9),p.color,.8,.5);this.txt(p.name,pos.x+R+3,pos.y,p.color,8);});}
  _sun(){const S=this.w2c(0,0),t=performance.now()/1000;[[22,.022,'#ff7010'],[13,.06,'#ffb030'],[6,.25,'#fff0a0']].forEach(([r,a,c])=>this.circ(S.x,S.y,r*(1+.03*Math.sin(t*1.2)),null,c,0,a));this.circ(S.x,S.y,5,'#fff8d0','#fffcb0',1);}
  _hud(){const{W,H,zoom}=this,bAU=zoom>80?.5:zoom>40?1:2,bpx=bAU*zoom,bx=14,by=H-16;this.ln(bx,by,bx+bpx,by,'rgba(82,90,120,.7)',1.5);this.ln(bx,by-4,bx,by+4,'rgba(82,90,120,.7)',1.5);this.ln(bx+bpx,by-4,bx+bpx,by+4,'rgba(82,90,120,.7)',1.5);this.txt(bAU+' AU',bx+bpx/2-10,by-7,'rgba(82,90,120,.8)',7.5,false);}
}

// Porkchop and Planet VPs (Hohmann mode)
let pkD=null,pkMetric='c3',pkBusy=false;
const PK_RX=96,PK_RY=64;
function pkColor(v,vmin,vmax){let t=Math.max(0,Math.min(1,(v-vmin)/(vmax-vmin)));t=Math.pow(t,.42);const S=[[0,[4,20,64]],[.2,[4,128,176]],[.45,[16,208,128]],[.65,[216,192,16]],[.82,[224,80,8]],[1,[176,4,4]]];for(let i=0;i<S.length-1;i++){if(t>=S[i][0]&&t<=S[i+1][0]){const f=(t-S[i][0])/(S[i+1][0]-S[i][0]);return S[i][1].map((c,j)=>(c+(S[i+1][1][j]-c)*f)|0);}}return S[S.length-1][1];}
async function computePK(){
  if(pkBusy)return;pkBusy=true;const pg=document.getElementById('v1-prog'),bar=document.getElementById('v1-bar'),msg=document.getElementById('v1-msg');pg.classList.add('vis');
  const span=parseInt(document.getElementById('pk-span').value)||780,tofMax=parseInt(document.getElementById('pk-tof').value)||400,tofMin=30;
  const gc3=new Float32Array(PK_RX*PK_RY).fill(NaN),gdv=new Float32Array(PK_RX*PK_RY).fill(NaN);
  for(let yi=0;yi<PK_RY;yi++){for(let xi=0;xi<PK_RX;xi++){
    const td_d=xi/(PK_RX-1)*span,tof_d=tofMin+yi/(PK_RY-1)*(tofMax-tofMin);
    const td_yr=ST.epochYr+td_d/365.25,ta_yr=ST.epochYr+(td_d+tof_d)/365.25;
    const s1=planetState(ST.orig,td_yr),s2=planetState(ST.dest,ta_yr);
    const lam=lambert({x:s1.x,y:s1.y},{x:s2.x,y:s2.y},tof_d);if(!lam)continue;
    const vi1=Math.sqrt((lam.v1.x-s1.vx)**2+(lam.v1.y-s1.vy)**2)*AUyr;
    const vi2=Math.sqrt((lam.v2.x-s2.vx)**2+(lam.v2.y-s2.vy)**2)*AUyr;
    const h1=hyperbola(vi1,PL[ST.orig].mu,PL[ST.orig].R+ST.h_park);
    const h2=hyperbola(vi2,PL[ST.dest].mu,PL[ST.dest].R+ST.h_cap);
    gc3[yi*PK_RX+xi]=vi1*vi1/1e6;gdv[yi*PK_RX+xi]=h1&&h2?(h1.dv+h2.dv)/1e3:NaN;
  }if(yi%4===0){bar.style.width=((yi/PK_RY)*100).toFixed(0)+'%';msg.textContent=`Lambert ${((yi/PK_RY)*100).toFixed(0)}%`;await new Promise(r=>setTimeout(r,0));}}
  pkD={gc3,gdv,PK_RX,PK_RY,span,tofMax,tofMin};bar.style.width='100%';await new Promise(r=>setTimeout(r,30));pg.classList.remove('vis');pkBusy=false;vpPK.draw();
}
class PorkchopVP{
  constructor(){this.cv=document.getElementById('c1');this.ctx=this.cv.getContext('2d');this.DPR=Math.min(devicePixelRatio||1,2);this.W=1;this.H=1;this._bind();new ResizeObserver(()=>this._resize()).observe(this.cv.parentElement);this._resize();}
  _resize(){const el=this.cv.parentElement;this.cv.width=el.clientWidth*this.DPR;this.cv.height=el.clientHeight*this.DPR;this.W=this.cv.width;this.H=this.cv.height;this.draw();}
  get pad(){return{l:44*this.DPR,r:18*this.DPR,t:22*this.DPR,b:38*this.DPR};}
  get pw(){return this.W-this.pad.l-this.pad.r;}get ph(){return this.H-this.pad.t-this.pad.b;}
  g2s(xi,yi,RX,RY){return{x:this.pad.l+(xi/(RX-1))*this.pw,y:this.H-this.pad.b-(yi/(RY-1))*this.ph};}
  s2g(sx,sy,RX,RY){return{xi:Math.round((sx-this.pad.l)/this.pw*(RX-1)),yi:Math.round((this.H-this.pad.b-sy)/this.ph*(RY-1))};}
  _bind(){
    this.cv.addEventListener('mousemove',e=>{
      const rect=this.cv.getBoundingClientRect();const sx=(e.clientX-rect.left)*this.DPR,sy=(e.clientY-rect.top)*this.DPR;
      if(ST.mode==='hohmann')this._hoverHoh(sx,sy,e.clientX,e.clientY);
      else this._hoverCarpet(sx,sy,e.clientX,e.clientY);
    });
    this.cv.addEventListener('click',e=>{
      const rect=this.cv.getBoundingClientRect();const sx=(e.clientX-rect.left)*this.DPR,sy=(e.clientY-rect.top)*this.DPR;
      if(ST.mode==='hohmann')this._selectHoh(sx,sy);
      else this._selectCarpet(sx,sy);
    });
  }
  _hoverHoh(sx,sy,cx,cy){if(!pkD)return;const{xi,yi}=this.s2g(sx,sy,pkD.PK_RX,pkD.PK_RY);if(xi<0||xi>=pkD.PK_RX||yi<0||yi>=pkD.PK_RY){hideTip('tip1');return;}const idx=yi*pkD.PK_RX+xi;const c3=pkD.gc3[idx],dv=pkD.gdv[idx];if(isNaN(c3)){hideTip('tip1');return;}const td=xi/(pkD.PK_RX-1)*pkD.span,tof=pkD.tofMin+yi/(pkD.PK_RY-1)*(pkD.tofMax-pkD.tofMin);showTip('tip1',cx+12,cy-34,`Salida: ${yrToDate(ST.epochYr+td/365.25)}`,`TOF: ${tof.toFixed(0)} d`,`C₃: ${c3.toFixed(2)} km²/s²`,`Δv_tot: ${isNaN(dv)?'n/a':dv.toFixed(3)+' km/s'}`);}
  _hoverCarpet(sx,sy,cx,cy){if(!carpetData)return;const{xi,yi}=this.s2g(sx,sy,carpetData.RX,carpetData.RY);if(xi<0||xi>=carpetData.RX||yi<0||yi>=carpetData.RY){hideTip('tip1');return;}const idx=yi*carpetData.RX+xi;const v=carpetData.grid[idx];if(isNaN(v)){hideTip('tip1');return;}const h_km=ALT_MIN+(xi/(carpetData.RX-1))*(ALT_MAX-ALT_MIN);const isp1=ISP1_MIN+(yi/(carpetData.RY-1))*(ISP1_MAX-ISP1_MIN);const{vcirc,grav,drag,total}=dvOrbit(h_km);showTip('tip1',cx+12,cy-50,`Alt. objetivo: ${h_km.toFixed(0)} km`,`Isp₁: ${isp1.toFixed(0)} s`,`λ payload: ${v.toFixed(2)} %`,`Δv_total: ${(total/1e3).toFixed(2)} km/s`,`Δv_orb: ${(vcirc/1e3).toFixed(2)} · g: ${(grav/1e3).toFixed(2)} · d: ${(drag/1e3).toFixed(2)}`);}
  _selectHoh(sx,sy){if(!pkD)return;const{xi,yi}=this.s2g(sx,sy,pkD.PK_RX,pkD.PK_RY);if(xi<0||xi>=pkD.PK_RX||yi<0||yi>=pkD.PK_RY)return;const idx=yi*pkD.PK_RX+xi;if(isNaN(pkD.gc3[idx]))return;
    const td_d=xi/(pkD.PK_RX-1)*pkD.span,tof_d=pkD.tofMin+yi/(pkD.PK_RY-1)*(pkD.tofMax-pkD.tofMin);
    const ta_d=td_d+tof_d,td_yr=ST.epochYr+td_d/365.25,ta_yr=ST.epochYr+ta_d/365.25;
    const s1=planetState(ST.orig,td_yr),s2=planetState(ST.dest,ta_yr);
    const lam=lambert({x:s1.x,y:s1.y},{x:s2.x,y:s2.y},tof_d);if(!lam)return;
    const vi1=Math.sqrt((lam.v1.x-s1.vx)**2+(lam.v1.y-s1.vy)**2)*AUyr;
    const vi2=Math.sqrt((lam.v2.x-s2.vx)**2+(lam.v2.y-s2.vy)**2)*AUyr;
    const h1=hyperbola(vi1,PL[ST.orig].mu,PL[ST.orig].R+ST.h_park);
    const h2=hyperbola(vi2,PL[ST.dest].mu,PL[ST.dest].R+ST.h_cap);
    ST.sel={t_dep_d:td_d,t_arr_d:ta_d,tof_d,c3:pkD.gc3[idx],vi1,vi2,dv_esc:h1?h1.dv:0,dv_cap:h2?h2.dv:0,h1,h2,lam,s1,s2,xi,yi};
    const sp=this.g2s(xi,yi,pkD.PK_RX,pkD.PK_RY);const el=document.getElementById('selpt');el.classList.add('vis');el.style.left=(sp.x/this.DPR)+'px';el.style.top=(sp.y/this.DPR)+'px';
    updateHohRight();vpSS.draw();vpDep.draw();vpArr.draw();}
  _selectCarpet(sx,sy){if(!carpetData)return;const{xi,yi}=this.s2g(sx,sy,carpetData.RX,carpetData.RY);if(xi<0||xi>=carpetData.RX||yi<0||yi>=carpetData.RY)return;const idx=yi*carpetData.RX+xi;if(isNaN(carpetData.grid[idx]))return;const h_km=ALT_MIN+(xi/(carpetData.RX-1))*(ALT_MAX-ALT_MIN);document.getElementById('asc-htgt').value=Math.round(h_km);document.getElementById('v-htgt').textContent=Math.round(h_km)+' km';updateAscLeft();}
  draw(){
    const{ctx,W,H}=this;ctx.fillStyle='#04050a';ctx.fillRect(0,0,W,H);
    if(ST.mode==='hohmann') this._drawHoh();
    else this._drawCarpet();
  }
  _drawHoh(){
    const{W,H}=this;
    if(!pkD){const{ctx}=this;ctx.fillStyle='rgba(82,90,120,.6)';ctx.font=`${10*this.DPR}px JetBrains Mono,monospace`;ctx.textAlign='center';ctx.fillText('⟳ Calcular para generar el Porkchop Plot',W/2,H/2);ctx.textAlign='start';return;}
    this._heatmap(pkMetric==='c3'?pkD.gc3:pkD.gdv,pkD.PK_RX,pkD.PK_RY);
    this._axes('Fecha salida →','TOF →',pkD.PK_RX,pkD.PK_RY,(xi)=>yrToDate(ST.epochYr+(xi/(pkD.PK_RX-1))*pkD.span/365.25).slice(0,7),(yi)=>(pkD.tofMin+yi/(pkD.PK_RY-1)*(pkD.tofMax-pkD.tofMin)).toFixed(0)+'d');
    this._minimum(pkMetric==='c3'?pkD.gc3:pkD.gdv,pkD.PK_RX,pkD.PK_RY,pkMetric==='c3'?1:2);
    this._selMarker(pkD.PK_RX,pkD.PK_RY);this._colorbar();
  }
  _drawCarpet(){
    if(!carpetData){const{ctx,W,H}=this;ctx.fillStyle='rgba(82,90,120,.6)';ctx.font=`${10*this.DPR}px JetBrains Mono,monospace`;ctx.textAlign='center';ctx.fillText('⟳ Calcular carpet plot',W/2,H/2);ctx.textAlign='start';return;}
    this._heatmap(carpetData.grid,carpetData.RX,carpetData.RY);
    this._axes('Alt. objetivo (km) →','Isp₁ (s) →',carpetData.RX,carpetData.RY,
      (xi)=>Math.round(ALT_MIN+(xi/(carpetData.RX-1))*(ALT_MAX-ALT_MIN))+'km',
      (yi)=>Math.round(ISP1_MIN+(yi/(carpetData.RY-1))*(ISP1_MAX-ISP1_MIN))+'s');
    this._minimum(carpetData.grid,carpetData.RX,carpetData.RY,2);
    this._colorbar(true);
  }
  _heatmap(grid,RX,RY){
    const{ctx,pad,pw,ph,W,H}=this;
    const vals=[...grid].filter(v=>isFinite(v)&&!isNaN(v)).sort((a,b)=>a-b);if(!vals.length)return;
    const vmin=vals[0],vmax=vals[Math.floor(vals.length*.95)];this._vmin=vmin;this._vmax=vmax;
    const ipw=Math.round(pw),iph=Math.round(ph);if(ipw<=0||iph<=0)return;
    const img=ctx.createImageData(ipw,iph);
    for(let py=0;py<iph;py++){for(let px=0;px<ipw;px++){
      const xi=Math.min(RX-1,Math.max(0,Math.round(px/ipw*(RX-1))));
      const yi=Math.min(RY-1,Math.max(0,Math.round((1-py/iph)*(RY-1))));
      const v=grid[yi*RX+xi];const o=(py*ipw+px)*4;
      if(isNaN(v)||!isFinite(v)){img.data[o]=8;img.data[o+1]=9;img.data[o+2]=16;img.data[o+3]=255;}
      else{const[r,g,b]=pkColor(v,vmin,vmax);img.data[o]=r;img.data[o+1]=g;img.data[o+2]=b;img.data[o+3]=255;}
    }}
    ctx.putImageData(img,pad.l,pad.t);
  }
  _axes(xlbl,ylbl,RX,RY,xfmt,yfmt){
    const{ctx,pad,pw,ph,W,H,DPR}=this;
    ctx.save();ctx.strokeStyle='rgba(28,34,54,.9)';ctx.lineWidth=.8;ctx.strokeRect(pad.l,pad.t,pw,ph);
    ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;
    for(let i=0;i<=8;i++){const f=i/8,sx=pad.l+f*pw;ctx.strokeStyle='rgba(20,24,38,.5)';ctx.lineWidth=.5;ctx.setLineDash([2,5]);ctx.beginPath();ctx.moveTo(sx,pad.t);ctx.lineTo(sx,H-pad.b);ctx.stroke();ctx.setLineDash([]);ctx.save();ctx.translate(sx,H-pad.b+4);ctx.rotate(-Math.PI/4);ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText(xfmt(Math.round(i/8*(RX-1))),0,0);ctx.restore();}
    for(let i=0;i<=5;i++){const f=i/5,sy=H-pad.b-f*ph;ctx.strokeStyle='rgba(20,24,38,.5)';ctx.lineWidth=.5;ctx.setLineDash([2,5]);ctx.beginPath();ctx.moveTo(pad.l,sy);ctx.lineTo(W-pad.r,sy);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText(yfmt(Math.round(f*(RY-1))),2,sy+3);}
    ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText(xlbl,pad.l+pw/2-40,H-4);
    ctx.save();ctx.translate(10,pad.t+ph/2+20);ctx.rotate(-Math.PI/2);ctx.fillText(ylbl,0,0);ctx.restore();ctx.restore();
  }
  _minimum(grid,RX,RY,decimals){let mV=Infinity,mXi=0,mYi=0;for(let yi=0;yi<RY;yi++)for(let xi=0;xi<RX;xi++){const v=grid[yi*RX+xi];if(!isNaN(v)&&v<mV){mV=v;mXi=xi;mYi=yi;}}const pos=this.g2s(mXi,mYi,RX,RY),d=7*this.DPR;const{ctx}=this;ctx.save();ctx.strokeStyle='#3ae882';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(pos.x-d,pos.y);ctx.lineTo(pos.x+d,pos.y);ctx.moveTo(pos.x,pos.y-d);ctx.lineTo(pos.x,pos.y+d);ctx.stroke();ctx.font=`${7.5*this.DPR}px JetBrains Mono,monospace`;ctx.fillStyle='#3ae882';ctx.fillText('min='+mV.toFixed(decimals),pos.x+d+2,pos.y-2);ctx.restore();}
  _selMarker(RX,RY){if(!ST.sel)return;const pos=this.g2s(ST.sel.xi,ST.sel.yi,RX,RY),t=performance.now()/900,R=(4+1.5*Math.sin(t))*this.DPR;const{ctx}=this;ctx.save();ctx.strokeStyle='#e8a017';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(pos.x,pos.y,R,0,TAU);ctx.stroke();ctx.strokeStyle='rgba(232,160,23,.25)';ctx.lineWidth=.8;ctx.setLineDash([3,5]);ctx.beginPath();ctx.moveTo(this.pad.l,pos.y);ctx.lineTo(pos.x-R-2,pos.y);ctx.moveTo(pos.x+R+2,pos.y);ctx.lineTo(this.W-this.pad.r,pos.y);ctx.moveTo(pos.x,this.pad.t);ctx.lineTo(pos.x,pos.y-R-2);ctx.moveTo(pos.x,pos.y+R+2);ctx.lineTo(pos.x,this.H-this.pad.b);ctx.stroke();ctx.restore();}
  _colorbar(isPayload=false){const cv=document.getElementById('cbar-cv'),ctx=cv.getContext('2d');if(this._vmin===undefined)return;const{_vmin:vmin,_vmax:vmax}=this;for(let py=0;py<120;py++){const t=1-py/120;const[r,g,b]=pkColor(vmin+(vmax-vmin)*Math.pow(t,1/.42),vmin,vmax);ctx.fillStyle=`rgb(${r},${g},${b})`;ctx.fillRect(0,py,14,1);}const lbl=document.getElementById('cbar-lbls');lbl.innerHTML='';[1,.75,.5,.25,0].forEach(f=>{const d=document.createElement('div');d.textContent=(vmin+(vmax-vmin)*f).toFixed(1);lbl.appendChild(d);});document.getElementById('cbar-unit').textContent=isPayload?'λ %':pkMetric==='c3'?'km²/s²':'km/s';}
}

class PlanetVP extends VP{
  constructor(id,role){super(id,0.001);this.role=role;}
  get _pk(){return this.role==='dep'?ST.orig:ST.dest;}
  get _h(){return this.role==='dep'?ST.h_park:ST.h_cap;}
  get _hyp(){return ST.sel?(this.role==='dep'?ST.sel.h1:ST.sel.h2):null;}
  get _vi(){return ST.sel?(this.role==='dep'?ST.sel.vi1:ST.sel.vi2):null;}
  get _col(){return this.role==='dep'?'#17d4e8':'#8b6ef5';}
  autoFit(){const p=PL[this._pk],soi_km=p.soi/1e3;const minDim=Math.min(this.W,this.H)*.45;this.zoom=minDim/(soi_km/6);this.defZoom=this.zoom;this.pan={x:0,y:0};}
  draw(){
    if(ST.mode!=='hohmann'){this.bg();const{ctx,W,H}=this;ctx.fillStyle='rgba(82,90,120,.25)';ctx.font=`${9*this.DPR}px JetBrains Mono,monospace`;ctx.textAlign='center';ctx.fillText('Modo Ascenso activo',W/2,H/2);ctx.textAlign='start';return;}
    this.bg();const p=PL[this._pk];if(!p)return;
    const Rkm=p.R/1e3,O=this.w2c(0,0);const{ctx,W,H,zoom}=this;
    ctx.save();ctx.setLineDash([2,8]);ctx.strokeStyle='rgba(20,24,38,.5)';ctx.lineWidth=.4;[1,2,4,8,16].forEach(f=>{ctx.beginPath();ctx.arc(O.x,O.y,f*Rkm*zoom,0,TAU);ctx.stroke();});ctx.restore();
    this.ln(0,O.y,W,O.y,'rgba(20,24,38,.4)',.4);this.ln(O.x,0,O.x,H,'rgba(20,24,38,.4)',.4);
    const soi_km=p.soi/1e3,soi_px=soi_km*zoom;this.circ(O.x,O.y,soi_px,p.color+'44',null,.7,1,[5,10]);
    const atm_px=(Rkm*1.1)*zoom;const g=ctx.createRadialGradient(O.x,O.y,Rkm*zoom,O.x,O.y,atm_px);g.addColorStop(0,p.color+'50');g.addColorStop(1,'transparent');ctx.save();ctx.fillStyle=g;ctx.beginPath();ctx.arc(O.x,O.y,atm_px,0,TAU);ctx.fill();ctx.restore();
    this.circ(O.x,O.y,Rkm*zoom,p.color,p.color+'22',1.5);this.txt(p.name+' R='+Rkm.toFixed(0)+'km',O.x+Rkm*zoom+4,O.y,p.color,9);
    const rp_km=(p.R+this._h)/1e3,rp_px=rp_km*zoom;this.circ(O.x,O.y,rp_px,'rgba(23,212,232,.6)',null,1,1,[4,7]);const vc_kms=Math.sqrt(p.mu/(p.R+this._h))/1e3;this.txt('Parkeo '+rp_km.toFixed(0)+'km v_c='+vc_kms.toFixed(2)+'km/s',O.x+rp_px*.71+2,O.y-rp_px*.71,'rgba(23,212,232,.75)',7.5);
    if(this._hyp)this._drawHyp(p,Rkm,this._hyp,this._col);
    const lines=[this.role==='dep'?'HIPÉRBOLA ESCAPE':'HIPÉRBOLA CAPTURA',p.name+'  μ='+(p.mu/1e12).toFixed(2)+'×10¹² m³/s²',this._vi?'v∞ = '+(this._vi/1e3).toFixed(3)+' km/s':'← Seleccionar en Porkchop'];
    const dp=this.DPR;ctx.save();ctx.font=`${8*dp}px JetBrains Mono,monospace`;lines.forEach((l,i)=>{ctx.fillStyle=i===0?this._col+'cc':'rgba(82,90,120,.75)';ctx.fillText(l,12,H-38+i*13*dp);});ctx.restore();
  }
  _drawHyp(p,Rkm,hyp,col){const a=hyp.a/1e3,e=hyp.e,thInf=hyp.th_inf,N=200,eps=0.04,pts=[];for(let i=0;i<=N;i++){const nu=-thInf+eps+(2*thInf-2*eps)*i/N,r=a*(e*e-1)/(1+e*Math.cos(nu));if(r<0||r>1e7)continue;const ang=nu+Math.PI/2;pts.push(this.w2c(r*Math.cos(ang),r*Math.sin(ang)));}this.poly(pts,col,1.5,.9);this.poly(pts,col,5,.08);const O=this.w2c(0,0);for(const sign of[-1,1]){const ang=thInf*sign+Math.PI/2+Math.PI;const fp=this.w2c(1e6*Math.cos(ang),1e6*Math.sin(ang));this.ln(O.x,O.y,fp.x,fp.y,col,.6,.2,[3,8]);}const rp_km=hyp.r_p/1e3,peri=this.w2c(0,-rp_km);this.circ(peri.x,peri.y,5,col,col+'80',1.5);const dvL=Math.min(60,Math.max(15,hyp.dv/200))*this.DPR;this.arr(peri.x,peri.y,peri.x+dvL,peri.y,'#e84a3a',1.5,5);this.txt('Δv='+(hyp.dv/1e3).toFixed(3)+'km/s',peri.x+dvL+4,peri.y,'#e84a3a',8.5);this.txt('e='+e.toFixed(4),peri.x+dvL+4,peri.y+12,col,7.5);if(this._vi)this.txt('v∞='+(this._vi/1e3).toFixed(3)+'km/s',peri.x+dvL+4,peri.y+22,col,7.5);}
}
// ══════════════════════════════════════════════════════════════
// ASCENT VPs
// ══════════════════════════════════════════════════════════════

// ── VP0 ASCENT: Earth cross-section + trajectory ──────────────
class EarthVP extends VP{
  constructor(){super('c0',1e-5);} // 1e-5 px/m default
  autoFit(){this.zoom=Math.min(this.W,this.H)*0.35/R_E;this.defZoom=this.zoom;this.pan={x:0,y:0};}
  draw(){
    if(ST.mode!=='ascent'){return;}
    this.bg();this._atmLayers();this._earth();this._orbit();this._traj();this._hud();
  }
  _atmLayers(){
    const O=this.w2c(0,0),{ctx}=this;
    // Atmosphere bands (altitude × zoom)
    const bands=[{h:0,color:'rgba(10,30,80,.18)',label:''},{h:12e3,color:'rgba(10,60,30,.12)',label:'Estratosfera'},{h:50e3,color:'rgba(40,10,80,.10)',label:'Mesosfera'},{h:85e3,color:'rgba(10,10,60,.08)',label:'Termosfera'},{h:500e3,color:'rgba(0,0,20,.04)',label:''}];
    for(let i=bands.length-1;i>=0;i--){const b=bands[i];const r=(R_E+b.h)*this.zoom;ctx.save();ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(O.x,O.y,r,0,TAU);ctx.fill();ctx.restore();if(b.label&&r<this.W){ctx.save();ctx.fillStyle='rgba(82,90,120,.45)';ctx.font=`${7*this.DPR}px JetBrains Mono,monospace`;ctx.fillText(b.label,O.x+r*.7+2,O.y,'rgba(82,90,120,.45)');ctx.restore();}}
  }
  _earth(){
    const O=this.w2c(0,0),R=R_E*this.zoom,{ctx}=this;
    const grd=ctx.createRadialGradient(O.x,O.y,R*.6,O.x,O.y,R);
    grd.addColorStop(0,'#0a2a50');grd.addColorStop(.7,'#0d3a28');grd.addColorStop(1,'#0a2010');
    this.circ(O.x,O.y,R,null,null,0);ctx.save();ctx.fillStyle=grd;ctx.beginPath();ctx.arc(O.x,O.y,R,0,TAU);ctx.fill();ctx.restore();
    this.circ(O.x,O.y,R,'rgba(23,212,232,.4)',null,1.5);
    this.txt('Tierra  R=6371km',O.x+R+4,O.y,'rgba(42,106,200,.8)',8);
  }
  _orbit(){
    const h_tgt=parseFloat(document.getElementById('asc-htgt').value)*1e3||400e3;
    const R_orb=(R_E+h_tgt)*this.zoom,O=this.w2c(0,0);
    this.circ(O.x,O.y,R_orb,'rgba(58,232,130,.45)',null,1,[6,9]);
    this.txt('Órbita '+Math.round(h_tgt/1e3)+' km',O.x+R_orb*.71+2,O.y,'rgba(58,232,130,.7)',8);
  }
  _traj(){
    const res=ST.asc_result;if(!res||!res.traj.length)return;
    const O=this.w2c(0,0);
    // Convert (x_downrange, h_altitude) to polar coords around Earth center
    // Launch from (0, R_E), theta = x/R_E, r = R_E + h
    const pts=res.traj.map(p=>{
      const theta_rad=p.x/(R_E+p.h/2); // approximate downrange angle
      const r=R_E+p.h;
      const wx=r*Math.sin(theta_rad),wy=r*Math.cos(theta_rad);
      return this.w2c(wx,wy);
    });
    // Color by phase (stage)
    let pLast=pts[0];
    for(let i=1;i<pts.length;i++){
      const si_=res.traj[i].si;
      const col=si_===0?'#e8a017':si_===1?'#8b6ef5':'#17d4e8';
      this.ln(pLast.x,pLast.y,pts[i].x,pts[i].y,col,1.8,.8);
      pLast=pts[i];
    }
    this.gradLine(pts,'rgba(232,160,23,.15)','rgba(23,212,232,.15)',6);

    // Events (staging, MaxQ, orbit)
    res.events.forEach(ev=>{
      const theta_rad=ev.x/(R_E+ev.h/2),r=R_E+ev.h;
      const pp=this.w2c(r*Math.sin(theta_rad),r*Math.cos(theta_rad));
      const t_=performance.now()/900,pulse=1+.2*Math.sin(t_*3);
      if(ev.type==='sep'){this.circ(pp.x,pp.y,6*pulse,'#e8a017',null,1.5);this.txt(`Sep. E${ev.si+1}`,pp.x+8,pp.y,'#e8a017',8);}
      if(ev.type==='orbit'){this.circ(pp.x,pp.y,7*pulse,'#3ae882','#3ae88240',1.5);this.txt('ÓRBITA',pp.x+9,pp.y,'#3ae882',9);}
    });
    // Launch point
    const pLaunch=this.w2c(0,R_E);
    this.circ(pLaunch.x,pLaunch.y,5,'#17d4e8','#17d4e840',1.5);this.txt('Launch',pLaunch.x+6,pLaunch.y,'#17d4e8',8);
    // MaxQ marker
    if(res.maxQ>0){
      const theta_mq=0,r_mq=R_E+res.maxQ_h,pp=this.w2c(r_mq*Math.sin(theta_mq),r_mq*Math.cos(theta_mq));
      this.circ(pp.x,pp.y,5,'#e84a3a',null,1.5,[3,4]);this.txt('MaxQ',pp.x+6,pp.y,'#e84a3a',7.5);
    }
  }
  _hud(){
    const{W,H,zoom}=this;
    const barM=zoom*R_E>.4*W?1e6:zoom*R_E>0.1*W?5e6:R_E;
    const bpx=barM*zoom,bx=14,by=H-16;
    this.ln(bx,by,bx+bpx,by,'rgba(82,90,120,.7)',1.5);this.ln(bx,by-4,bx,by+4,'rgba(82,90,120,.7)',1.5);this.ln(bx+bpx,by-4,bx+bpx,by+4,'rgba(82,90,120,.7)',1.5);
    this.txt((barM/1e3).toFixed(0)+' km',bx+bpx/2-12,by-7,'rgba(82,90,120,.8)',7.5,false);
  }
}

// ── VP1 ASCENT: Carpet plot (uses PorkchopVP dynamically) ──────
// (already handled in PorkchopVP via mode check)

// ── VP2 ASCENT: Altitude vs Velocity profile ──────────────────
class VelAltVP extends VP{
  constructor(){super('c2',1);}
  draw(){
    if(ST.mode!=='ascent'){this.bg();return;}
    this.bg();
    const res=ST.asc_result;
    const h_tgt=parseFloat(document.getElementById('asc-htgt').value)*1e3||400e3;
    const{ctx,W,H,DPR}=this;
    const PAD={l:55*DPR,r:20*DPR,t:22*DPR,b:35*DPR};
    const pw=W-PAD.l-PAD.r,ph=H-PAD.t-PAD.b;

    const H_MAX=(h_tgt+50e3)/1e3; // km
    const V_MAX=Math.sqrt(MU_E/(R_E+h_tgt))/1e3*1.15; // km/s

    // Coordinate helpers (not world2canvas, just plot coords)
    const px=(v_kms)=>PAD.l+v_kms/V_MAX*pw;
    const py=(h_km)=>H-PAD.b-h_km/H_MAX*ph;

    // Grid
    ctx.save();ctx.strokeStyle='rgba(20,24,38,.8)';ctx.lineWidth=.5;ctx.setLineDash([2,6]);
    for(let v=0;v<=V_MAX;v+=0.5){const x=px(v);ctx.beginPath();ctx.moveTo(x,PAD.t);ctx.lineTo(x,H-PAD.b);ctx.stroke();}
    for(let h=0;h<=H_MAX;h+=100){const y=py(h);ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(W-PAD.r,y);ctx.stroke();}
    ctx.setLineDash([]);ctx.restore();

    // Reference: circular velocity curve v_circ(h)
    const cPts=[];for(let h=0;h<=H_MAX;h+=10){const v=Math.sqrt(MU_E/(R_E+h*1e3))/1e3;if(v<V_MAX)cPts.push({x:px(v),y:py(h)});}
    ctx.save();ctx.strokeStyle='rgba(58,232,130,.5)';ctx.lineWidth=1.2;ctx.setLineDash([4,5]);ctx.beginPath();if(cPts.length){ctx.moveTo(cPts[0].x,cPts[0].y);cPts.forEach(p=>ctx.lineTo(p.x,p.y));}ctx.stroke();ctx.setLineDash([]);ctx.restore();
    ctx.save();ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='rgba(58,232,130,.7)';ctx.fillText('v_circ(h)',px(V_MAX*.5),py(h_tgt/1e3/2)+10);ctx.restore();

    // Trajectory v-h path
    if(res&&res.traj.length){
      const pts=res.traj.map(p=>({x:px(Math.sqrt(p.vx**2+p.vh**2)/1e3),y:py(p.h/1e3),si:p.si}));
      for(let i=1;i<pts.length;i++){const col=pts[i].si===0?'#e8a017':pts[i].si===1?'#8b6ef5':'#17d4e8';ctx.save();ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(pts[i-1].x,pts[i-1].y);ctx.lineTo(pts[i].x,pts[i].y);ctx.stroke();ctx.restore();}
      // MaxQ
      if(res.maxQ>0){const mq_pt=res.traj.find(p=>p.h>=res.maxQ_h*0.99);if(mq_pt){const mx=px(Math.sqrt(mq_pt.vx**2+mq_pt.vh**2)/1e3),my=py(mq_pt.h/1e3);ctx.save();ctx.strokeStyle='#e84a3a';ctx.lineWidth=1;ctx.beginPath();ctx.arc(mx,my,5,0,TAU);ctx.stroke();ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='#e84a3a';ctx.fillText('MaxQ q='+res.maxQ.toFixed(0)+' Pa',mx+7,my);ctx.restore();}}
      // Final point
      const lp=pts[pts.length-1];ctx.save();ctx.strokeStyle='#3ae882';ctx.fillStyle='#3ae882';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(lp.x,lp.y,5,0,TAU);ctx.stroke();ctx.font=`${8*DPR}px JetBrains Mono,monospace`;ctx.fillText('Fin',lp.x+7,lp.y);ctx.restore();
    }else{ctx.save();ctx.fillStyle='rgba(82,90,120,.5)';ctx.font=`${9*DPR}px JetBrains Mono,monospace`;ctx.textAlign='center';ctx.fillText('▶ Simular trayectoria',W/2,H/2);ctx.textAlign='start';ctx.restore();}

    // Axes labels
    ctx.save();ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='rgba(82,90,120,.85)';
    for(let v=0;v<=V_MAX;v+=0.5){const x=px(v);ctx.fillText(v.toFixed(1),x-8,H-PAD.b+12);}
    for(let h=0;h<=H_MAX;h+=100){const y=py(h);ctx.fillText(h+'km',2,y+3);}
    ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText('Velocidad (km/s) →',PAD.l+pw/2-40,H-4);
    ctx.save();ctx.translate(11,PAD.t+ph/2+15);ctx.rotate(-Math.PI/2);ctx.fillText('Altitud →',0,0);ctx.restore();
    ctx.restore();

    // Legend
    ctx.save();ctx.font=`${8*DPR}px JetBrains Mono,monospace`;
    [{col:'#e8a017',lbl:'Etapa 1'},{col:'#8b6ef5',lbl:'Etapa 2'},{col:'#17d4e8',lbl:'Crucero'}].forEach(({col,lbl},i)=>{ctx.fillStyle=col;ctx.fillRect(W-PAD.r-60,PAD.t+5+i*13,8,8);ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText(lbl,W-PAD.r-48,PAD.t+12+i*13);});
    ctx.restore();
  }
}

// ── VP3 ASCENT: Atmospheric density + dynamic pressure profile ──
class AtmVP extends VP{
  constructor(){super('c3',1);}
  draw(){
    if(ST.mode!=='ascent'){this.bg();return;}
    this.bg();
    const res=ST.asc_result;
    const{ctx,W,H,DPR}=this;
    const PAD={l:58*DPR,r:20*DPR,t:22*DPR,b:35*DPR};
    const pw=W-PAD.l-PAD.r,ph=H-PAD.t-PAD.b;
    const h_tgt=parseFloat(document.getElementById('asc-htgt').value)*1e3||400e3;
    const H_MAX=Math.max(h_tgt+20e3,120e3)/1e3;

    const py=(h_km)=>H-PAD.b-h_km/H_MAX*ph;

    // Atmosphere density profile (left axis) and dynamic pressure (right axis, if simulation exists)
    const rhoMax=1.3,qMax=50000; // kg/m³, Pa

    // Density profile
    const rhoPts=[];for(let h=0;h<=H_MAX;h+=1){const rho=isaDensity(h*1e3);if(rho>1e-10){const x=PAD.l+(Math.log10(rho)+7)/7*pw;rhoPts.push({x,y:py(h)});}}
    ctx.save();ctx.strokeStyle='rgba(74,144,232,.7)';ctx.lineWidth=1.5;if(rhoPts.length){ctx.beginPath();ctx.moveTo(rhoPts[0].x,rhoPts[0].y);rhoPts.forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();}ctx.restore();

    // Atmosphere layer fills
    const layers=[{h0:0,h1:11,col:'rgba(10,40,100,.12)',name:'Troposfera'},{h0:11,h1:50,col:'rgba(10,80,20,.10)',name:'Estratosfera'},{h0:50,h1:85,col:'rgba(60,10,80,.08)',name:'Mesosfera'},{h0:85,h1:Math.min(H_MAX,600),col:'rgba(10,10,60,.06)',name:'Termosfera'}];
    layers.forEach(l=>{
      if(l.h0>=H_MAX)return;
      const y0=py(l.h0),y1=py(Math.min(l.h1,H_MAX));
      ctx.save();ctx.fillStyle=l.col;ctx.fillRect(PAD.l,y1,pw,y0-y1);ctx.restore();
      ctx.save();ctx.font=`${7*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='rgba(82,90,120,.6)';ctx.fillText(l.name,PAD.l+3,py((l.h0+Math.min(l.h1,H_MAX))/2));ctx.restore();
    });

    // Dynamic pressure from simulation
    if(res&&res.traj.length){
      const qPts=res.traj.map(p=>({x:PAD.l+(p.q/qMax)*pw*0.5,y:py(p.h/1e3)})); // right half
      ctx.save();ctx.strokeStyle='rgba(232,74,58,.8)';ctx.lineWidth=1.5;if(qPts.length){ctx.beginPath();ctx.moveTo(qPts[0].x,qPts[0].y);qPts.forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();}ctx.restore();
      // MaxQ line
      if(res.maxQ>0){const yMQ=py(res.maxQ_h/1e3);ctx.save();ctx.strokeStyle='rgba(232,74,58,.4)';ctx.lineWidth=.8;ctx.setLineDash([4,6]);ctx.beginPath();ctx.moveTo(PAD.l,yMQ);ctx.lineTo(W-PAD.r,yMQ);ctx.stroke();ctx.setLineDash([]);ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='#e84a3a';ctx.fillText('MaxQ '+res.maxQ_h.toFixed(0)+'m',W-PAD.r-60,yMQ-3);ctx.restore();}
    }

    // Target orbit line
    ctx.save();ctx.strokeStyle='rgba(58,232,130,.4)';ctx.lineWidth=.8;ctx.setLineDash([3,6]);
    const y_orb=py(h_tgt/1e3);ctx.beginPath();ctx.moveTo(PAD.l,y_orb);ctx.lineTo(W-PAD.r,y_orb);ctx.stroke();ctx.setLineDash([]);ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='rgba(58,232,130,.7)';ctx.fillText('Órbita '+Math.round(h_tgt/1e3)+'km',W-PAD.r-70,y_orb-3);ctx.restore();

    // Altitude axis
    ctx.save();ctx.font=`${7.5*DPR}px JetBrains Mono,monospace`;ctx.fillStyle='rgba(82,90,120,.85)';
    const step=H_MAX>400?100:H_MAX>150?50:20;for(let h=0;h<=H_MAX;h+=step){const y=py(h);ctx.fillText(h+'km',2,y+3);}
    ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText('Densidad atm. ISA →',PAD.l+pw*0.1,H-4);
    if(res)ctx.fillText('← Presión dinámica q',PAD.l+pw*0.45,H-4);
    ctx.save();ctx.translate(11,PAD.t+ph/2+20);ctx.rotate(-Math.PI/2);ctx.fillText('Altitud →',0,0);ctx.restore();
    ctx.restore();

    // Legend
    ctx.save();ctx.font=`${8*DPR}px JetBrains Mono,monospace`;
    ctx.strokeStyle='rgba(74,144,232,.7)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(W-PAD.r-90,PAD.t+8);ctx.lineTo(W-PAD.r-75,PAD.t+8);ctx.stroke();ctx.fillStyle='rgba(82,90,120,.8)';ctx.fillText('ρ(h) ISA',W-PAD.r-70,PAD.t+11);
    if(res){ctx.strokeStyle='rgba(232,74,58,.8)';ctx.beginPath();ctx.moveTo(W-PAD.r-90,PAD.t+21);ctx.lineTo(W-PAD.r-75,PAD.t+21);ctx.stroke();ctx.fillText('q(t)',W-PAD.r-70,PAD.t+24);}
    ctx.restore();
  }
}
// ══ TOOLTIP ════════════════════════════════════════════════════
function showTip(id,cx,cy,...lines){const el=document.getElementById(id);el.style.left=cx+'px';el.style.top=cy+'px';el.innerHTML=lines.map(l=>`<div class="tip-row"><b>${l.split(':')[0]}:</b>${l.split(':').slice(1).join(':')}</div>`).join('');el.classList.add('vis');}
function hideTip(id){document.getElementById(id).classList.remove('vis');}
function setv(id,txt,cls){const el=document.getElementById(id);if(!el)return;el.textContent=txt;el.className='dv'+(cls?' '+cls:'');}
function fkm(v,d=3){return isFinite(v)?(v/1e3).toFixed(d)+' km/s':'—';}
function fkg(kg){if(!isFinite(kg))return'—';return kg>=1e6?(kg/1e6).toFixed(2)+' Mt':kg>=1e3?(kg/1e3).toFixed(2)+' t':kg.toFixed(0)+' kg';}

// ══ HOHMANN RIGHT PANEL ════════════════════════════════════════
function updateHohRight(){
  const mf=parseFloat(document.getElementById('inp-mf').value)||5000;
  const m0a=mf/(1-ST.fp),dvcap=rocketDv(m0a,mf,ST.isp);
  setv('d-m0',fkg(m0a));setv('d-dvcap',fkm(dvcap),'gn');setv('r-m0a',fkg(m0a),'wh');
  const sel=ST.sel;
  if(!sel){['r-dep','r-arr','r-tof','r-vinf1','r-c3','r-dvesc','r-vpark','r-ehyp1','r-at','r-et','r-vper','r-vapo','r-phase','r-vinf2','r-dvcap2','r-dvtot','r-m0r','r-mpr','r-margin','r-eps','r-period','r-rpera'].forEach(id=>setv(id,'—'));return;}
  setv('r-dep',yrToDate(ST.epochYr+sel.t_dep_d/365.25));setv('r-arr',yrToDate(ST.epochYr+sel.t_arr_d/365.25));setv('r-tof',sel.tof_d.toFixed(0)+' d','am');
  setv('r-vinf1',fkm(sel.vi1));setv('r-c3',sel.c3.toFixed(2)+' km²/s²','bl');setv('r-dvesc',sel.h1?fkm(sel.h1.dv):'—');setv('r-vpark',sel.h1?(sel.h1.v_circ/1e3).toFixed(3)+' km/s':'—');setv('r-ehyp1',sel.h1?sel.h1.e.toFixed(4):'—');
  const r1=sel.s1.r,r2=sel.s2.r,at=(r1+r2)/2,et=Math.abs(r2-r1)/(r1+r2);
  const vper=Math.sqrt(MU_S_AU*(2/r1-1/at))*AUyr/1e3,vapo=Math.sqrt(MU_S_AU*(2/r2-1/at))*AUyr/1e3;
  const Thalf_d=365.25*Math.PI*Math.sqrt(at**3/MU_S_AU),eps_MJ=-MU_S/(2*at*AU)/1e6;
  const phase=((Math.PI-(TAU/(PL[ST.dest].T/365.25))*sel.tof_d/365.25)*180/Math.PI+360)%360;
  setv('r-at',at.toFixed(5)+' AU','am');setv('r-et',et.toFixed(6),'am');setv('r-vper',vper.toFixed(3)+' km/s','am');setv('r-vapo',vapo.toFixed(3)+' km/s','am');setv('r-phase',phase.toFixed(2)+'°','am');
  setv('r-vinf2',fkm(sel.vi2),'pu');setv('r-dvcap2',sel.h2?fkm(sel.h2.dv):'—','pu');
  const dvtot=sel.dv_esc+sel.dv_cap;setv('r-dvtot',fkm(dvtot),'rd');
  const{m0:m0r,mp,mr}=rocketM0(dvtot,ST.isp,mf);setv('r-m0r',fkg(m0r));setv('r-mpr',fkg(mp),'rd');const margin=dvcap-dvtot;setv('r-margin',fkm(margin),margin>=0?'gn':'rd');
  const fp_pct=Math.min(99,mp/m0r*100);document.getElementById('efill').style.width=fp_pct.toFixed(1)+'%';document.getElementById('el').textContent=fp_pct.toFixed(1)+'% prop.';document.getElementById('er').textContent=(100-fp_pct).toFixed(1)+'% struct.';
  setv('r-eps',eps_MJ.toFixed(3)+' MJ/kg');setv('r-period',Thalf_d.toFixed(1)+' d');setv('r-rpera',r1.toFixed(4)+' / '+r2.toFixed(4)+' AU','am');
}

// ══ ASCENT LEFT / RIGHT PANEL UPDATE ══════════════════════════
function updateAscLeft(){
  const h_tgt=parseFloat(document.getElementById('asc-htgt').value)*1e3||400e3;
  const vcirc=Math.sqrt(MU_E/(R_E+h_tgt));
  const{total:dvRef}=dvOrbit(h_tgt/1e3);
  setv('a-vcirc',(vcirc/1e3).toFixed(3)+' km/s','cy');
  setv('a-dvref',(dvRef/1e3).toFixed(3)+' km/s','am');
}

function readAscCfg(){
  return{
    stages:[
      {ms:parseFloat(document.getElementById('s1-ms').value)||8500,mp:parseFloat(document.getElementById('s1-mp').value)||95000,isp:parseFloat(document.getElementById('s1-isp').value)||280,thrust:parseFloat(document.getElementById('s1-thr').value)*1e3||1500e3},
      {ms:parseFloat(document.getElementById('s2-ms').value)||1800,mp:parseFloat(document.getElementById('s2-mp').value)||18000,isp:parseFloat(document.getElementById('s2-isp').value)||350,thrust:parseFloat(document.getElementById('s2-thr').value)*1e3||180e3},
    ],
    m_pay:parseFloat(document.getElementById('asc-pay').value)||3000,
    Cd:parseFloat(document.getElementById('asc-cd').value)||0.3,
    A_ref:parseFloat(document.getElementById('asc-ar').value)||12,
    kick_deg:parseFloat(document.getElementById('asc-kick').value)||5,
    h_tgt:parseFloat(document.getElementById('asc-htgt').value)*1e3||400e3,
  };
}

function updateAscRight(res){
  if(!res){setv('a-status','Sin simular','gn');['a-ttime','a-range','a-hmax','a-dv1','a-tw1','a-dvcap1','a-maxqh','a-maxq','a-dv2','a-tw2','a-dvcap2','a-vfx','a-vfy','a-vtot','a-vcreq','a-vdef','a-gloss','a-dloss','a-tloss','a-eff','a-m0','a-morb','a-lambda','a-eps1','a-eps2','a-dvtot'].forEach(id=>setv(id,'—'));return;}
  const cfg=readAscCfg();
  const orb=res.events.find(e=>e.type==='orbit');
  setv('a-status',orb?'Órbita alcanzada':'Trayectoria sub-orbital',orb?'gn':'rd');
  setv('a-ttime',res.t_total.toFixed(0)+' s');
  setv('a-range',(res.x_final/1e3).toFixed(0)+' km','am');
  setv('a-hmax',(res.hmax/1e3).toFixed(1)+' km','cy');
  // Stage 1
  setv('a-dv1',(res.dv1/1e3).toFixed(3)+' km/s','am');
  const m0=res.m0,tw1=cfg.stages[0].thrust/(m0*9.80665);setv('a-tw1',tw1.toFixed(3),'am');
  const dvcap1=rocketDv(cfg.stages[0].ms+cfg.stages[0].mp,cfg.stages[0].ms,cfg.stages[0].isp);setv('a-dvcap1',(dvcap1/1e3).toFixed(3)+' km/s','am');
  setv('a-maxqh',(res.maxQ_h/1e3).toFixed(1)+' km','am');setv('a-maxq',res.maxQ.toFixed(0)+' Pa','rd');
  // Stage 2
  setv('a-dv2',(res.dv2/1e3).toFixed(3)+' km/s','pu');
  const m0_2=cfg.stages[1].ms+cfg.stages[1].mp+cfg.m_pay,tw2=cfg.stages[1].thrust/(m0_2*9.80665);setv('a-tw2',tw2.toFixed(3),'pu');
  const dvcap2=rocketDv(cfg.stages[1].ms+cfg.stages[1].mp,cfg.stages[1].ms,cfg.stages[1].isp);setv('a-dvcap2',(dvcap2/1e3).toFixed(3)+' km/s','pu');
  // Orbit achieved
  const vfx=res.vfx,vfy=res.vfy,vtot=Math.sqrt(vfx**2+vfy**2);
  setv('a-vfx',(vfx/1e3).toFixed(3)+' km/s','cy');setv('a-vfy',(vfy/1e3).toFixed(3)+' km/s','cy');setv('a-vtot',(vtot/1e3).toFixed(3)+' km/s','cy');
  setv('a-vcreq',(res.v_circ_tgt/1e3).toFixed(3)+' km/s');
  const vdef=vtot-res.v_circ_tgt;setv('a-vdef',(vdef>=0?'+':'')+( vdef/1e3).toFixed(3)+' km/s',vdef>=0?'gn':'rd');
  // Losses
  setv('a-gloss',(res.grav_loss/1e3).toFixed(3)+' km/s','rd');setv('a-dloss',(res.drag_loss/1e3).toFixed(3)+' km/s','rd');const tloss=res.grav_loss+res.drag_loss;setv('a-tloss',(tloss/1e3).toFixed(3)+' km/s','rd');
  const dvtot_=res.dv1+res.dv2;const eff=res.v_circ_tgt/Math.max(dvtot_,1)*100;setv('a-eff',eff.toFixed(1)+'%','gn');
  // Mass
  setv('a-m0',fkg(m0));setv('a-morb',fkg(res.m_fin),'gn');const lambda=cfg.m_pay/m0*100;setv('a-lambda',lambda.toFixed(2)+'%','cy');
  const eps1=cfg.stages[0].ms/(cfg.stages[0].ms+cfg.stages[0].mp)*100;const eps2=cfg.stages[1].ms/(cfg.stages[1].ms+cfg.stages[1].mp)*100;
  setv('a-eps1',eps1.toFixed(1)+'%','am');setv('a-eps2',eps2.toFixed(1)+'%','pu');
  // Δv budget bar
  const dv_orb=res.v_circ_tgt,dv_total_est=dv_orb+res.grav_loss+res.drag_loss;
  const fo=dv_orb/dv_total_est*100,fg=res.grav_loss/dv_total_est*100,fd=res.drag_loss/dv_total_est*100;
  document.getElementById('dvb-orb').style.width=fo.toFixed(1)+'%';document.getElementById('dvb-grav').style.width=fg.toFixed(1)+'%';document.getElementById('dvb-drag').style.width=fd.toFixed(1)+'%';
  document.getElementById('dvb-orb-l').textContent=(dv_orb/1e3).toFixed(2)+'km/s';document.getElementById('dvb-grav-l').textContent=(res.grav_loss/1e3).toFixed(2)+'km/s';document.getElementById('dvb-drag-l').textContent=(res.drag_loss/1e3).toFixed(2)+'km/s';
  setv('a-dvtot',(dv_total_est/1e3).toFixed(3)+' km/s','rd');
}

// ══ VIEWPORT INSTANCES ════════════════════════════════════════
const vpSS=new SolarVP();
const vpPK=new PorkchopVP();
const vpDep=new PlanetVP('c2','dep');
const vpArr=new PlanetVP('c3','arr');
const vpEarth=new EarthVP();
const vpVelAlt=new VelAltVP();
const vpAtm=new AtmVP();
// Carpet uses vpPK (same canvas c1, mode-switched)

function fitHohPlanets(){vpDep.autoFit();vpArr.autoFit();}
function fitAscent(){vpEarth.autoFit();}

function drawAllVps(){
  if(ST.mode==='hohmann'){vpSS.draw();vpDep.draw();vpArr.draw();if(ST.sel)vpPK.draw();}
  else{vpEarth.draw();vpPK.draw();vpVelAlt.draw();vpAtm.draw();}
}

// ══ ANIMATION LOOP ════════════════════════════════════════════
let _lf=0,_fc=0,_ft=0;
function frame(now){
  requestAnimationFrame(frame);const dt=Math.min((now-_lf)/1000,.1);_lf=now;
  _fc++;_ft+=dt*1000;if(_ft>1000){document.querySelector('#sb-fps span').textContent=_fc;_fc=0;_ft=0;}
  if(ST.mode==='hohmann'){const spd=parseFloat(document.getElementById('sel-spd').value||7);ST.simT+=dt*spd/365.25;document.getElementById('sb-t').textContent=ST.simT.toFixed(3)+' yr';}
  drawAllVps();
}

// ══ MODE SWITCHING ════════════════════════════════════════════
function setMode(mode){
  ST.mode=mode;
  document.querySelectorAll('.htab').forEach(t=>t.classList.toggle('on',t.dataset.mode===mode));
  // Panels
  document.getElementById('lp-hoh').style.display=mode==='hohmann'?'block':'none';
  document.getElementById('lp-asc').style.display=mode==='ascent'?'block':'none';
  document.getElementById('rp-hoh').style.display=mode==='hohmann'?'block':'none';
  document.getElementById('rp-asc').style.display=mode==='ascent'?'block':'none';
  // VP names & badges
  if(mode==='hohmann'){
    document.getElementById('vp0-name').textContent='Sistema Solar · Eclíptica';document.getElementById('vp0-badge').textContent='Kepler real';document.getElementById('vp0-badge').className='vpbadge';
    document.getElementById('vp1-name').textContent='Porkchop Plot';document.getElementById('vp1-badge').textContent='C₃ km²/s²';document.getElementById('vp1-badge').className='vpbadge';
    document.getElementById('vp1-calc-btn').textContent='⟳ Calcular';
    document.getElementById('pk-ctrl-hoh').style.display='block';
    document.getElementById('vp2-name').textContent='Salida · '+PL[ST.orig].name;document.getElementById('vp2-badge').textContent='Hipérbola escape · km';document.getElementById('vp2-badge').className='vpbadge';
    document.getElementById('vp3-name').textContent='Llegada · '+PL[ST.dest].name;document.getElementById('vp3-badge').textContent='Hipérbola captura · km';document.getElementById('vp3-badge').className='vpbadge';
    document.getElementById('sb-info1').innerHTML='T_sim: <span id="sb-t">0.000 yr</span>';
    document.getElementById('sb-info2').innerHTML='Origen: <span id="sb-or">'+PL[ST.orig].name+'</span>';
  }else{
    document.getElementById('vp0-name').textContent='Tierra · Perfil trayectoria';document.getElementById('vp0-badge').textContent='Lat-lon eclíptica';document.getElementById('vp0-badge').className='vpbadge am';
    document.getElementById('vp1-name').textContent='Carpet Plot · Fracción payload';document.getElementById('vp1-badge').textContent='λ (%) vs alt / Isp₁';document.getElementById('vp1-badge').className='vpbadge gn';
    document.getElementById('vp1-calc-btn').textContent='⟳ Carpet';
    document.getElementById('pk-ctrl-hoh').style.display='none';
    document.getElementById('vp2-name').textContent='Perfil v(h) · Fases';document.getElementById('vp2-badge').textContent='km/s vs km altitud';document.getElementById('vp2-badge').className='vpbadge am';
    document.getElementById('vp3-name').textContent='Atmósfera ISA + q(t)';document.getElementById('vp3-badge').textContent='ρ log10 + presión dinámica';document.getElementById('vp3-badge').className='vpbadge pu';
    document.getElementById('sb-info1').textContent='';document.getElementById('sb-info2').textContent='';
  }
  document.getElementById('sb-mode').textContent=mode==='hohmann'?'Hohmann':'Ascenso';
  setTimeout(()=>{[vpSS,vpPK,vpDep,vpArr,vpEarth,vpVelAlt,vpAtm].forEach(v=>v._resize?.());},80);
}

// ══ EVENT HANDLERS ════════════════════════════════════════════
// Tabs
document.querySelectorAll('.htab').forEach(t=>t.addEventListener('click',function(){setMode(this.dataset.mode);}));

// HOH controls
function recomputeHoh(){ST.sel=null;document.getElementById('selpt').classList.remove('vis');updateHohRight();computePK();}
document.getElementById('inp-epoch').addEventListener('change',function(){ST.epochYr=epochYr(this.value);ST.simT=0;document.getElementById('sb-ep').textContent=this.value;recomputeHoh();});
document.getElementById('sel-orig').addEventListener('change',function(){ST.orig=this.value;document.getElementById('vp2-name').textContent='Salida · '+PL[ST.orig].name;vpDep.autoFit();recomputeHoh();});
document.getElementById('sel-dest').addEventListener('change',function(){ST.dest=this.value;document.getElementById('vp3-name').textContent='Llegada · '+PL[ST.dest].name;vpArr.autoFit();recomputeHoh();});
document.getElementById('r-hp').addEventListener('input',function(){ST.h_park=+this.value*1e3;document.getElementById('v-hp').textContent=this.value+' km';vpDep.autoFit();updateHohRight();});
document.getElementById('r-hc').addEventListener('input',function(){ST.h_cap=+this.value*1e3;document.getElementById('v-hc').textContent=this.value+' km';vpArr.autoFit();updateHohRight();});
document.getElementById('r-isp').addEventListener('input',function(){ST.isp=+this.value;document.getElementById('v-isp').textContent=this.value+' s';updateHohRight();});
document.getElementById('r-fp').addEventListener('input',function(){ST.fp=+this.value;document.getElementById('v-fp').textContent=(ST.fp*100).toFixed(0)+'%';updateHohRight();});
document.getElementById('inp-mf').addEventListener('input',updateHohRight);
document.getElementById('vp1-calc-btn').addEventListener('click',()=>{if(ST.mode==='hohmann')recomputeHoh();else{const cfg=readAscCfg();computeCarpet(+document.getElementById('s2-isp').value,+document.getElementById('s1-ms').value/(+document.getElementById('s1-ms').value+ +document.getElementById('s1-mp').value),+document.getElementById('s2-ms').value/(+document.getElementById('s2-ms').value+ +document.getElementById('s2-mp').value));}});
document.getElementById('btn-reset-hoh').addEventListener('click',()=>{document.getElementById('vpa').classList.remove('solo');document.querySelectorAll('.vp').forEach(v=>v.classList.remove('active'));vpSS.reset();fitHohPlanets();setTimeout(()=>[vpSS,vpPK,vpDep,vpArr].forEach(v=>v._resize?.()),80);});

// ASC controls
['s1-isp','s2-isp'].forEach(id=>{document.getElementById(id).addEventListener('input',function(){document.getElementById('v-'+id.replace('-','')).textContent=this.value+' s';});});
document.getElementById('asc-az').addEventListener('input',function(){document.getElementById('v-az').textContent=this.value+'°';});
document.getElementById('asc-htgt').addEventListener('input',function(){document.getElementById('v-htgt').textContent=this.value+' km';updateAscLeft();vpEarth.draw();vpVelAlt.draw();vpAtm.draw();});
document.getElementById('asc-cd').addEventListener('input',function(){document.getElementById('v-cd').textContent=(+this.value).toFixed(2);});
document.getElementById('asc-ar').addEventListener('input',function(){document.getElementById('v-ar').textContent=this.value+' m²';});
document.getElementById('asc-kick').addEventListener('input',function(){document.getElementById('v-kick').textContent=this.value+'°';});
document.getElementById('btn-sim').addEventListener('click',()=>{
  const cfg=readAscCfg();
  const res=simAscent(cfg);
  ST.asc_result=res;
  updateAscRight(res);
  vpEarth.draw();vpVelAlt.draw();vpAtm.draw();
});
document.getElementById('btn-reset-asc').addEventListener('click',()=>{
  document.getElementById('vpa').classList.remove('solo');document.querySelectorAll('.vp').forEach(v=>v.classList.remove('active'));
  vpEarth.autoFit();setTimeout(()=>[vpEarth,vpPK,vpVelAlt,vpAtm].forEach(v=>v._resize?.()),80);
});

// Viewport solo/reset buttons
document.addEventListener('click',e=>{
  const btn=e.target.closest('[data-vi]');if(!btn)return;
  const vi=parseInt(btn.dataset.vi),act=btn.dataset.a;
  const vpa=document.getElementById('vpa');const allVP=document.querySelectorAll('.vp');
  if(act==='solo'){if(vpa.classList.contains('solo')&&allVP[vi].classList.contains('active')){vpa.classList.remove('solo');allVP.forEach(v=>v.classList.remove('active'));}else{vpa.classList.add('solo');allVP.forEach((v,i)=>v.classList.toggle('active',i===vi));}setTimeout(()=>{[vpSS,vpPK,vpDep,vpArr,vpEarth,vpVelAlt,vpAtm].forEach(v=>v._resize?.());},80);}
  else if(act==='reset'){if(ST.mode==='hohmann'){[vpSS,null,vpDep,vpArr][vi]?.reset();if(vi===2)vpDep.autoFit();if(vi===3)vpArr.autoFit();}else{[vpEarth,null,vpVelAlt,vpAtm][vi]?.reset();if(vi===0)vpEarth.autoFit();}}
});

// HOH pk metric toggle - reuse vp1-extra-btn in hohmann mode
// Dynamically create if needed:
document.getElementById('vp1-extra-btn').addEventListener('click',()=>{pkMetric=pkMetric==='c3'?'dv':'c3';document.getElementById('vp1-extra-btn').textContent=pkMetric==='c3'?'→ Δv_tot':'→ C₃';vpPK.draw();});

// ── INIT ─────────────────────────────────────────────────────
// Fix DPR_ reference in PlanetVP
const DPR_=Math.min(devicePixelRatio||1,2);
document.getElementById('vp2-name').textContent='Salida · '+PL[ST.orig].name;
document.getElementById('vp3-name').textContent='Llegada · '+PL[ST.dest].name;
// Show hohm pk metric btn
document.getElementById('vp1-extra-btn').textContent='→ Δv_tot';
document.getElementById('vp1-extra-btn').style.display='inline';
fitHohPlanets();fitAscent();
updateHohRight();updateAscLeft();updateAscRight(null);
computePK();
requestAnimationFrame(frame);
</script>
</body>
</html>