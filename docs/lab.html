<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laboratorio - Calculadora Cient√≠fica</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Familjen+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0e12;--s0:#13141a;--s1:#1a1c24;--s2:#22252f;
  --border:#2a2d3a;--border2:#363a4a;
  --txt:#e4e6f0;--txt2:#8b90a8;--txt3:#52566a;
}
body{background:var(--bg);color:var(--txt);font-family:'Familjen Grotesk',sans-serif;min-height:100vh;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);}
.app{max-width:1200px;margin:0 auto;padding:32px 20px 80px;position:relative;z-index:1;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:36px;gap:16px;flex-wrap:wrap;}
.hdr-kicker{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.22em;color:var(--txt3);text-transform:uppercase;margin-bottom:6px;}
.hdr-title{font-family:'Instrument Serif',serif;font-size:3.4rem;line-height:1;
  background:linear-gradient(135deg,#e4e6f0 30%,#52566a 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em;}
.hdr-title em{font-style:italic;}
.hdr-pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.pill{display:flex;align-items:center;gap:7px;background:var(--s1);border:1px solid var(--border);
  border-radius:100px;padding:7px 14px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt2);}
.pdot{width:7px;height:7px;border-radius:50%;background:var(--txt3);transition:background .3s,box-shadow .3s;flex-shrink:0;}
.pdot.live{background:#4ade80;box-shadow:0 0 0 3px rgba(74,222,128,.2);animation:blink 1.4s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:900px){.layout{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--s0);border:1px solid var(--border);border-radius:16px;padding:22px;}
.card-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.22em;color:var(--txt3);
  text-transform:uppercase;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.card-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ‚îÄ‚îÄ NEW SERIES FORM ‚îÄ‚îÄ */
.nsform{display:flex;gap:8px;margin-bottom:14px;}
.nsinput{flex:1;min-width:0;background:var(--s2);border:1px solid var(--border);border-radius:10px;
  padding:9px 13px;font-family:'Familjen Grotesk',sans-serif;font-size:13px;font-weight:600;
  color:var(--txt);outline:none;transition:border-color .2s;}
.nsinput::placeholder{color:var(--txt3);font-weight:400;}
.nsinput:focus{border-color:var(--border2);}
.clrbtn{width:36px;height:36px;border-radius:9px;border:1px solid var(--border2);cursor:pointer;
  position:relative;overflow:hidden;flex-shrink:0;transition:transform .15s;}
.clrbtn:hover{transform:scale(1.08);}
.clrbtn input[type=color]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;border:none;}
.addbtn{width:36px;height:36px;border-radius:9px;border:1px solid var(--border);background:var(--txt);
  color:var(--bg);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:background .2s,transform .15s;}
.addbtn:hover{background:#c0c4d8;transform:scale(1.06);}

/* ‚îÄ‚îÄ SERIES GRID ‚îÄ‚îÄ */
.sgrid{display:flex;flex-direction:column;gap:10px;}
.nohint{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt3);text-align:center;padding:18px 0;}

/* ‚îÄ‚îÄ SERIES CARD ‚îÄ‚îÄ */
.sc{background:var(--s1);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:border-color .25s,box-shadow .25s;}
.sc.active{border-color:var(--c,#4ade80);
  box-shadow:0 0 0 1px color-mix(in srgb,var(--c,#4ade80) 20%,transparent),
             inset 0 0 32px color-mix(in srgb,var(--c,#4ade80) 4%,transparent);}
.sc-top{display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;user-select:none;}
.sc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:box-shadow .3s;}
.sc.active .sc-dot{box-shadow:0 0 0 3px color-mix(in srgb,var(--c,#4ade80) 30%,transparent);}
.sc-name{font-weight:700;font-size:13px;flex:1;}
.sc-badge{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.1em;
  color:#0d0e12;background:var(--c,#4ade80);border-radius:100px;padding:2px 9px;display:none;}
.sc.active .sc-badge{display:block;}
.sc-order{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);
  background:var(--s2);border-radius:6px;padding:2px 7px;display:none;}
.sc.active .sc-order{display:block;}
.sc-timer{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--c,var(--txt2));min-width:52px;text-align:right;}
.sc-pts{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);}
.sc-del{width:22px;height:22px;border-radius:6px;border:none;background:transparent;color:var(--txt3);
  cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;
  transition:color .15s,background .15s;flex-shrink:0;}
.sc-del:hover{color:#f87171;background:rgba(248,113,113,.12);}

/* ‚îÄ‚îÄ SERIES DETAILS ‚îÄ‚îÄ */
.sc-det{padding:0 14px 12px;border-top:1px solid var(--border);display:none;flex-direction:column;gap:8px;}
.sc.active .sc-det{display:flex;}

/* mic row */
.mic-row{display:flex;align-items:center;gap:8px;padding-top:10px;}
.mic-row label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.14em;
  color:var(--txt3);text-transform:uppercase;flex-shrink:0;}
.mic-sel{flex:1;min-width:0;background:var(--s2);border:1px solid var(--border);border-radius:8px;
  padding:6px 10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt);
  outline:none;cursor:pointer;transition:border-color .2s;}
.mic-sel:focus{border-color:var(--border2);}
.mic-row.hidden{display:none;}

/* rec + action buttons row */
.sc-btmrow{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.recbtn{display:flex;align-items:center;gap:6px;padding:6px 13px;border-radius:8px;
  border:1px solid var(--border);background:var(--s2);color:var(--txt2);
  font-family:'Familjen Grotesk',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.recbtn:hover{border-color:var(--c,#4ade80);color:var(--c,#4ade80);}
.recbtn.on{border-color:var(--c,#4ade80);background:color-mix(in srgb,var(--c,#4ade80) 10%,transparent);color:var(--c,#4ade80);}

/* small icon-only buttons for per-series actions */
.sc-action{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:7px;
  border:1px solid var(--border);background:var(--s2);color:var(--txt3);
  cursor:pointer;transition:all .2s;flex-shrink:0;}
.sc-action:hover{border-color:var(--border2);color:var(--txt2);}
.sc-action.danger:hover{border-color:rgba(248,113,113,.4);color:#f87171;background:rgba(248,113,113,.08);}
.sc-action.export:hover{border-color:rgba(74,222,128,.4);color:#4ade80;background:rgba(74,222,128,.06);}
.sc-action[title]{position:relative;}

.mbars{display:flex;align-items:center;gap:2px;height:18px;opacity:0;transition:opacity .3s;margin-left:2px;}
.mbars.on{opacity:1;}
.mb{width:3px;border-radius:3px;height:4px;background:var(--c,#4ade80);animation:mbw .65s ease-in-out infinite;}
.mb:nth-child(1){animation-delay:.0s}.mb:nth-child(2){animation-delay:.1s}
.mb:nth-child(3){animation-delay:.2s}.mb:nth-child(4){animation-delay:.3s}
.mb:nth-child(5){animation-delay:.2s}.mb:nth-child(6){animation-delay:.1s}
@keyframes mbw{0%,100%{height:3px}50%{height:16px}}

.sc-heard{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txt3);
  background:var(--s2);border-radius:8px;padding:7px 11px;min-height:32px;line-height:1.5;
  border-left:2px solid transparent;transition:border-color .2s,color .2s;}
.sc-heard.interim{border-color:#a78bfa;color:var(--txt2);font-style:italic;}
.sc-heard.ok{border-color:var(--c,#4ade80);color:var(--txt);}
.sc-heard.miss{border-color:#f87171;color:#f87171;}

/* ‚îÄ‚îÄ HINT CARD ‚îÄ‚îÄ */
.hintcard{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px 20px;}
.hinttitle{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.18em;color:var(--txt3);text-transform:uppercase;margin-bottom:12px;}
.hintgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.hintitem{background:var(--s2);border-radius:10px;padding:10px 12px;}
.hintitem .ex{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txt);margin-bottom:4px;}
.hintitem .ex span{color:#4ade80;}
.hintitem .desc{font-size:11px;color:var(--txt3);}

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-scroll{max-height:160px;overflow-y:auto;display:flex;flex-direction:column;gap:5px;}
.log-scroll::-webkit-scrollbar{width:3px;}
.log-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.lrow{display:flex;align-items:center;gap:9px;background:var(--s1);border-radius:8px;padding:7px 11px;
  animation:fadeUp .25s ease;border-left:2px solid transparent;}
.lrow.fresh{border-left-color:var(--lc,var(--txt));}
@keyframes fadeUp{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.lt{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);min-width:42px;}
.lname{font-size:12px;font-weight:700;flex:1;}
.ltimer{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);min-width:38px;}
.lval{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:500;}
.lempty{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt3);text-align:center;padding:16px 0;}

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.chart-wrap{grid-column:1/-1;}
.chart-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
.chart-title{font-family:'Instrument Serif',serif;font-size:1.35rem;font-style:italic;}
.chart-meta{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt3);}

/* tension slider */
.tension-row{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.tension-row label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.18em;color:var(--txt3);text-transform:uppercase;white-space:nowrap;}
.tension-row input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:3px;background:var(--border2);
  border-radius:3px;outline:none;cursor:pointer;}
.tension-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;
  border-radius:50%;background:#4ade80;border:2px solid var(--s2);cursor:pointer;transition:transform .15s;}
.tension-row input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2);}
.tension-val{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt2);min-width:28px;text-align:right;}

.legend{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.lpill{display:flex;align-items:center;gap:6px;background:var(--s1);border:1px solid var(--border);
  border-radius:100px;padding:4px 12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt2);}
.ldot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
canvas#chart{display:block;width:100%;height:300px;border-radius:10px;}
.chart-empty{height:300px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--txt3);}
.chart-empty svg{opacity:.25;}
.chart-empty p{font-family:'JetBrains Mono',monospace;font-size:12px;}

/* ‚îÄ‚îÄ GLOBAL CONTROLS ‚îÄ‚îÄ */
.controls-card{grid-column:1/-1;}
.ctrlrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.btn{display:flex;align-items:center;gap:7px;padding:9px 18px;border-radius:10px;
  border:1px solid var(--border);background:var(--s1);color:var(--txt2);
  font-family:'Familjen Grotesk',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn:hover{border-color:var(--border2);color:var(--txt);background:var(--s2);}
.btn:disabled{opacity:.3;cursor:not-allowed;pointer-events:none;}
.btn-g{border-color:rgba(74,222,128,.4);color:#4ade80;background:rgba(74,222,128,.06);}
.btn-g:hover{background:rgba(74,222,128,.14);}
.btn-r{border-color:rgba(248,113,113,.3);color:#f87171;background:rgba(248,113,113,.05);}
.btn-r:hover{background:rgba(248,113,113,.12);}
.btn-b{border-color:rgba(56,189,248,.3);color:#38bdf8;background:rgba(56,189,248,.05);}
.btn-b:hover{background:rgba(56,189,248,.12);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;
  z-index:400;opacity:0;pointer-events:none;transition:opacity .25s;backdrop-filter:blur(6px);}
.mbg.show{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:18px;padding:28px;
  max-width:340px;width:92%;transform:scale(.95);transition:transform .25s;box-shadow:0 32px 80px rgba(0,0,0,.5);}
.mbg.show .modal{transform:scale(1);}
.modal h2{font-family:'Instrument Serif',serif;font-size:1.35rem;font-style:italic;margin-bottom:8px;}
.modal p{font-size:13px;color:var(--txt2);margin-bottom:22px;line-height:1.6;}
.modal-btns{display:flex;gap:10px;justify-content:flex-end;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--s2);border:1px solid var(--border2);border-radius:12px;padding:10px 22px;
  font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--txt);
  z-index:500;white-space:nowrap;transition:transform .35s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 8px 32px rgba(0,0,0,.4);}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:#4ade80;color:#4ade80;}
.toast.warn{border-color:#fbbf24;color:#fbbf24;}
.toast.err{border-color:#f87171;color:#f87171;}

/* hidden file input */
#csvImport{display:none;}

/* ‚îÄ‚îÄ ANALYSIS PANEL ‚îÄ‚îÄ */
.analysis-card{grid-column:1/-1;}
.anl-tabs{display:flex;gap:6px;margin-bottom:18px;flex-wrap:wrap;}
.anl-tab{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.14em;text-transform:uppercase;
  padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:var(--s1);
  color:var(--txt3);cursor:pointer;transition:all .2s;}
.anl-tab:hover{border-color:var(--border2);color:var(--txt2);}
.anl-tab.sel{border-color:#38bdf8;background:rgba(56,189,248,.08);color:#38bdf8;}
.anl-pane{display:none;flex-direction:column;gap:14px;}
.anl-pane.vis{display:flex;}
.anl-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.anl-label{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.18em;
  color:var(--txt3);text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.anl-sel,.anl-input{background:var(--s2);border:1px solid var(--border);border-radius:8px;
  padding:7px 11px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txt);
  outline:none;cursor:pointer;transition:border-color .2s;}
.anl-sel:focus,.anl-input:focus{border-color:var(--border2);}
.anl-input{width:110px;cursor:text;}
.anl-btn{padding:7px 16px;border-radius:8px;border:1px solid rgba(56,189,248,.4);
  background:rgba(56,189,248,.07);color:#38bdf8;
  font-family:'Familjen Grotesk',sans-serif;font-size:12px;font-weight:600;
  cursor:pointer;transition:all .2s;white-space:nowrap;}
.anl-btn:hover{background:rgba(56,189,248,.16);}
.anl-results{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:16px 20px;
  display:none;flex-direction:column;gap:10px;}
.anl-results.vis{display:flex;}
.anl-eq{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--txt);
  background:var(--s2);border-radius:8px;padding:10px 14px;letter-spacing:.02em;border-left:3px solid #38bdf8;
  word-break:break-all;}
.anl-metrics{display:flex;gap:8px;flex-wrap:wrap;}
.anl-metric{background:var(--s2);border-radius:8px;padding:8px 12px;display:flex;flex-direction:column;gap:3px;}
.anl-metric-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.2em;
  color:var(--txt3);text-transform:uppercase;}
.anl-metric-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:500;color:var(--txt);}
.anl-pts-note{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txt3);}
.lagrange-eval{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding-top:4px;}
.lagrange-eval-result{font-family:'JetBrains Mono',monospace;font-size:13px;color:#a78bfa;
  background:rgba(167,139,250,.08);border:1px solid rgba(167,139,250,.25);
  border-radius:8px;padding:7px 13px;display:none;}
.lagrange-eval-result.vis{display:block;}
canvas#anlChart,canvas#lagChart{display:block;width:100%;height:220px;border-radius:10px;margin-top:4px;}
</style>
</head>
<body>
<div class="app">

  <header class="hdr">
    
    <div>
      <div class="hdr-kicker">// multi-channel voice logger</div>
      <div class="hdr-title">Voice<em>Chart</em></div>
    </div>
    <div class="hdr-pills">
      <div class="pill"><div class="pdot" id="hdot"></div><span id="hstatus">inactivo</span></div>
      <div class="pill" id="apill" style="display:none;"><span id="acnt">0</span>&nbsp;activa(s)</div>
    </div>
  </header>

  <div class="layout">

    <!-- LEFT: series manager + hints -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="card">
        <div class="card-label">Series de datos</div>
        <div class="nsform">
          <input class="nsinput" id="nsname" type="text" placeholder="Nombre de la serie‚Ä¶" maxlength="22"
            onkeydown="if(event.key==='Enter')addSeries()">
          <div class="clrbtn" id="clrbtn">
            <input type="color" id="nscolor" value="#4ade80">
          </div>
          <button class="addbtn" onclick="addSeries()">+</button>
        </div>
        <div class="sgrid" id="sgrid"></div>
        <div class="nohint" id="nohint">A√±ade al menos una serie para comenzar</div>
      </div>

      <div class="hintcard">
        <div class="hinttitle">Modo de entrada</div>
        <div class="hintgrid">
          <div class="hintitem"><div class="ex"><span>"cuarenta y dos"</span></div><div class="desc">1 serie activa ‚Üí 1 valor</div></div>
          <div class="hintitem"><div class="ex"><span>"veinte, quince"</span></div><div class="desc">2 series ‚Üí por orden de activaci√≥n</div></div>
          <div class="hintitem"><div class="ex"><span>"3 punto 5"</span></div><div class="desc">Decimales en espa√±ol</div></div>
          <div class="hintitem"><div class="ex"><span>Mic independiente</span></div><div class="desc">Visible si hay varios micros</div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: log -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="card" style="flex:1;">
        <div class="card-label">Historial <span id="lcnt" style="color:var(--txt2);font-weight:700;margin-left:4px;"></span></div>
        <div class="log-scroll" id="logscroll">
          <div class="lempty">Sin datos todav√≠a</div>
        </div>
      </div>
    </div>

    <!-- CHART -->
    <div class="card chart-wrap">
      <div class="chart-top">
        <span class="chart-title">Gr√°fica temporal</span>
        <span class="chart-meta" id="cmeta">0 puntos</span>
      </div>
      <div class="tension-row">
        <label>Suavidad</label>
        <input type="range" id="tension" min="0" max="1" step="0.05" value="0.4">
        <span class="tension-val" id="tensionVal">0.4</span>
      </div>
      <div class="legend" id="legend" style="display:none;"></div>
      <div id="cempty" class="chart-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        <p>Los datos aparecer√°n aqu√≠ en tiempo real</p>
      </div>
      <canvas id="chart" style="display:none;"></canvas>
    </div>

    <!-- GLOBAL CONTROLS -->
    <div class="card controls-card">
      <div class="ctrlrow">
        <button class="btn btn-g" id="ebtn" onclick="exportCSV(null)" disabled>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>Exportar todo
        </button>
        <button class="btn btn-b" onclick="document.getElementById('csvImport').click()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"
              transform="rotate(180 12 12)"/>
          </svg>Importar CSV
        </button>
        <button class="btn" id="ubtn" onclick="undoLast(null)" disabled>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M3 10h10a8 8 0 0 1 0 16H3"/><polyline points="3 10 7 6 3 2"/>
          </svg>Deshacer
        </button>
        <button class="btn btn-r" id="cbtn" onclick="askClear(null)" disabled>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
          </svg>Limpiar todo
        </button>
        <button class="btn" id="stopbtn" onclick="stopAll()" disabled>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <rect x="6" y="6" width="12" height="12" rx="2"/>
          </svg>Detener todo
        </button>
      </div>
    </div>

    <!-- ANALYSIS -->
    <div class="card analysis-card">
      <div class="card-label">An√°lisis matem√°tico</div>
      <div class="anl-tabs">
        <button class="anl-tab sel" onclick="anlTab('reg')" id="tab-reg">Regresi√≥n</button>
        <button class="anl-tab" onclick="anlTab('lagrange')" id="tab-lagrange">Interpolaci√≥n de Lagrange</button>
      </div>

      <!-- REGRESSION -->
      <div class="anl-pane vis" id="pane-reg">
        <div class="anl-row">
          <span class="anl-label">Serie</span>
          <select class="anl-sel" id="reg-series"></select>
          <span class="anl-label">Tipo</span>
          <select class="anl-sel" id="reg-type">
            <option value="linear">Lineal  y = a¬∑x + b</option>
            <option value="poly2">Polinomial grado 2</option>
            <option value="poly3">Polinomial grado 3</option>
            <option value="exp">Exponencial  y = a¬∑e·µáÀ£</option>
            <option value="log">Logar√≠tmica  y = a¬∑ln(x) + b</option>
            <option value="power">Potencial  y = a¬∑x·µá</option>
          </select>
          <button class="anl-btn" onclick="runRegression()">Calcular</button>
        </div>
        <div class="anl-results" id="reg-results">
          <div class="anl-eq" id="reg-eq"></div>
          <div class="anl-metrics" id="reg-metrics"></div>
          <div class="anl-pts-note" id="reg-note"></div>
          <canvas id="anlChart"></canvas>
        </div>
      </div>

      <!-- LAGRANGE -->
      <div class="anl-pane" id="pane-lagrange">
        <div class="anl-row">
          <span class="anl-label">Serie</span>
          <select class="anl-sel" id="lag-series"></select>
          <button class="anl-btn" onclick="runLagrange()">Calcular polinomio</button>
        </div>
        <div class="anl-results" id="lag-results">
          <div class="anl-eq" id="lag-eq"></div>
          <div class="anl-metrics" id="lag-metrics"></div>
          <div class="lagrange-eval">
            <span class="anl-label">Evaluar en x =</span>
            <input class="anl-input" type="number" id="lag-x" placeholder="valor de x" step="any">
            <button class="anl-btn" onclick="evalLagrange()">‚Üí f(x)</button>
            <div class="lagrange-eval-result" id="lag-result"></div>
          </div>
          <canvas id="lagChart"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Confirm modal -->
<div class="mbg" id="mbg" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h2 id="modal-title">¬øBorrar todo?</h2>
    <p id="modal-body">Se eliminar√°n todos los puntos. Los cron√≥metros se reiniciar√°n. Las series se conservan.</p>
    <div class="modal-btns">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-r" id="modal-confirm" onclick="modalConfirmCb&&modalConfirmCb()">S√≠, borrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="csvImport" accept=".csv,text/csv">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NUMBER PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NW={
  'cero':0,'un':1,'uno':1,'una':1,'dos':2,'tres':3,'cuatro':4,'cinco':5,
  'seis':6,'siete':7,'ocho':8,'nueve':9,'diez':10,'once':11,'doce':12,
  'trece':13,'catorce':14,'quince':15,'diecis√©is':16,'dieciseis':16,
  'diecisiete':17,'dieciocho':18,'diecinueve':19,'veinte':20,
  'veintiuno':21,'veintid√≥s':22,'veintidos':22,'veintitr√©s':23,'veintitres':23,
  'veinticuatro':24,'veinticinco':25,'veintis√©is':26,'veintiseis':26,
  'veintisiete':27,'veintiocho':28,'veintinueve':29,'treinta':30,
  'cuarenta':40,'cincuenta':50,'sesenta':60,'setenta':70,'ochenta':80,
  'noventa':90,'cien':100,'ciento':100,'doscientos':200,'trescientos':300,
  'cuatrocientos':400,'quinientos':500,'seiscientos':600,'setecientos':700,
  'ochocientos':800,'novecientos':900,'mil':1000
};
function parseOne(raw){
  const t=raw.toLowerCase().replace(/,/g,'.').trim();
  const d=parseFloat(t);
  if(!isNaN(d)&&/^-?[\d.]+$/.test(t))return d;
  const words=t.split(/[\s\-]+/);
  let total=0,cur=0,dec=null,found=false;
  for(const w of words){
    if(w==='y'||w==='con')continue;
    if(w==='punto'||w==='coma'){dec=0;continue;}
    if(NW[w]!==undefined){
      found=true;const v=NW[w];
      if(dec!==null){dec++;cur+=v/Math.pow(10,dec);}
      else if(v===1000){total=(total+(cur||1))*1000;cur=0;}
      else if(v>=100){cur=(cur||1)*v;}
      else cur+=v;
    }else{const n=parseFloat(w);if(!isNaN(n)){found=true;cur+=n;}}
  }
  total+=cur;
  return(found&&total!==0)?total:NaN;
}
function parseMulti(raw){
  const parts=raw.split(/[,;]|\by\b|\be\b/gi).map(s=>s.trim()).filter(Boolean);
  if(parts.length>1){const nums=parts.map(parseOne);if(nums.every(n=>!isNaN(n)))return nums;}
  const dm=raw.match(/-?\d+(?:[.,]\d+)?/g);
  if(dm&&dm.length>1){const nums=dm.map(s=>parseFloat(s.replace(',','.')));if(nums.every(n=>!isNaN(n)))return nums;}
  const single=parseOne(raw);
  return isNaN(single)?[]:[single];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S={
  series:[],  // {id,name,color,active,activatedAt,micId,rec,recObj,t0,elapsed}
  data:[],    // {sid,time,value,ts}
  mics:[],    // {deviceId,label}
  actOrder:[],
  tension:0.4,
};
let modalConfirmCb=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER (RAF ‚Äî no stale DOM refs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rafId=null;
function timerLoop(){
  const now=performance.now();
  S.series.forEach(s=>{
    if(!s.rec||s.t0===null)return;
    const el=document.getElementById('timer-'+s.id);
    if(el)el.textContent=fmtMs(s.elapsed+(now-s.t0));
  });
  rafId=requestAnimationFrame(timerLoop);
}
function startTimerLoop(){if(!rafId)rafId=requestAnimationFrame(timerLoop);}
function stopTimerLoop(){if(rafId){cancelAnimationFrame(rafId);rafId=null;}}
function seriesStartTimer(s){s.t0=performance.now();startTimerLoop();}
function seriesPauseTimer(s){if(s.t0!==null){s.elapsed+=performance.now()-s.t0;s.t0=null;}}
function seriesResetTimer(s){seriesPauseTimer(s);s.elapsed=0;}
function seriesGetSec(s){return+((s.elapsed+(s.t0!==null?performance.now()-s.t0:0))/1000).toFixed(2);}
function fmtMs(ms){const s=ms/1000;return s<100?s.toFixed(1)+'s':Math.round(s)+'s';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MIC ENUMERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enumMics(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true}).catch(()=>null);
    if(stream)stream.getTracks().forEach(t=>t.stop());
    const devs=await navigator.mediaDevices.enumerateDevices();
    S.mics=devs.filter(d=>d.kind==='audioinput')
      .map(d=>({deviceId:d.deviceId||'default',label:d.label||'Micr√≥fono'}));
  }catch(e){S.mics=[];}
  S.series.filter(s=>s.active).forEach(s=>refreshMicDropdown(s.id));
}
function refreshMicDropdown(sid){
  const row=document.getElementById('microw-'+sid);
  const sel=document.getElementById('micsel-'+sid);
  if(!row||!sel)return;
  const multi=S.mics.length>1;
  row.classList.toggle('hidden',!multi);
  if(!multi)return;
  const cur=sel.value||'default';
  sel.innerHTML=S.mics.map(m=>`<option value="${esc(m.deviceId)}"${m.deviceId===cur?' selected':''}>${esc(m.label.replace(/\s*\(.*?\)\s*$/,'').trim()||'Micr√≥fono')}</option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPEECH RECOGNITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
function makeRec(sid){
  if(!SR)return null;
  const r=new SR();
  r.lang='es-ES';r.continuous=true;r.interimResults=true;
  r.onresult=e=>{
    let inter='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const tx=e.results[i][0].transcript.trim();
      if(e.results[i].isFinal)onFinal(sid,tx);else inter=tx;
    }
    if(inter)setHeard(sid,inter,'interim');
  };
  r.onerror=e=>{
    if(e.error!=='no-speech'){
      const s=S.series.find(s=>s.id===sid);
      showToast(`Error (${s?.name||sid}): ${e.error}`,'err');
      stopRec(sid);
    }
  };
  r.onend=()=>{const s=S.series.find(s=>s.id===sid);if(s&&s.rec){try{r.start();}catch(_){}}};
  return r;
}
function startRec(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  if(!SR){showToast('Reconocimiento no disponible. Usa Chrome/Edge.','err');return;}
  if(!s.recObj)s.recObj=makeRec(sid);
  s.rec=true;seriesStartTimer(s);
  try{s.recObj.start();}catch(_){}
  updateRecBtn(sid);updateGlobal();
}
function stopRec(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  s.rec=false;seriesPauseTimer(s);
  try{s.recObj?.stop();}catch(_){}
  s.recObj=null;
  updateRecBtn(sid);setHeard(sid,'Di solo el n√∫mero‚Ä¶','');updateGlobal();
  if(!S.series.some(s=>s.rec))stopTimerLoop();
}
function toggleRec(sid){const s=S.series.find(s=>s.id===sid);if(s)s.rec?stopRec(sid):startRec(sid);}
function stopAll(){S.series.forEach(s=>{if(s.rec)stopRec(s.id);});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTI-VALUE DISPATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onFinal(sid,text){
  const nums=parseMulti(text);
  if(nums.length===0){setHeard(sid,text,'miss');showToast('No reconoc√≠ ning√∫n n√∫mero','warn');return;}
  if(nums.length===1){record(sid,nums[0]);setHeard(sid,`${text}  ‚Üí  ${fmt(nums[0])}`,'ok');return;}
  const active=S.actOrder.map(id=>S.series.find(s=>s.id===id)).filter(Boolean).filter(s=>s.active);
  if(!active.length)return;
  const myIdx=active.findIndex(s=>s.id===sid);
  const start=myIdx>=0?myIdx:0;
  nums.forEach((v,i)=>{
    const target=active[(start+i)%active.length];
    if(target){record(target.id,v);if(i>0)setHeard(target.id,`‚Üê ${fmt(v)}`,'ok');}
  });
  setHeard(sid,nums.map(fmt).join(' / ')+'  ‚úì','ok');
  showToast(`‚úì  ${nums.length} valores distribuidos`,'ok');
}
function record(sid,value){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  const entry={sid,value,time:seriesGetSec(s),ts:new Date().toLocaleTimeString('es-ES',{hour12:false})};
  S.data.push(entry);addLogRow(entry);redraw();ctrlSync();
  if(S.data.length===1||S.actOrder.length===1)showToast(`‚úì  ${s.name}: ${fmt(value)}`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SERIES MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PALETTE=['#4ade80','#a78bfa','#f87171','#38bdf8','#fb923c','#f472b6','#facc15','#34d399'];
let palIdx=0;
function addSeries(nameArg,colorArg){
  const ni=document.getElementById('nsname');
  const ci=document.getElementById('nscolor');
  const name=nameArg!=null?nameArg:(ni?ni.value.trim():'');
  const color=colorArg!=null?colorArg:(ci?ci.value:'#4ade80');
  if(!name){showToast('Escribe un nombre para la serie','warn');return;}
  S.series.push({id:'s'+Date.now(),name,color,active:false,activatedAt:0,micId:'default',
    rec:false,recObj:null,t0:null,elapsed:0});
  if(ni)ni.value='';
  render();advancePalette();
}
function deleteSeries(sid){
  if(S.data.some(d=>d.sid===sid)){showToast('Borra los datos de esta serie antes','warn');return;}
  stopRec(sid);S.series=S.series.filter(s=>s.id!==sid);S.actOrder=S.actOrder.filter(id=>id!==sid);
  render();updateGlobal();
}
function toggleActive(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  s.active=!s.active;
  if(s.active){
    s.activatedAt=Date.now();
    S.actOrder=[...S.actOrder.filter(id=>id!==sid),sid];
    render();refreshMicDropdown(sid);startRec(sid);
  }else{
    S.actOrder=S.actOrder.filter(id=>id!==sid);
    stopRec(sid);render();
  }
  updateGlobal();
}
function resetSeriesTimer(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  const wasRec=s.rec;
  if(wasRec)seriesPauseTimer(s);
  seriesResetTimer(s);
  if(wasRec)seriesStartTimer(s);
  const el=document.getElementById('timer-'+sid);
  if(el)el.textContent='0.0s';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PER-SERIES ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function undoSeries(sid){
  // Find last entry for this series
  const idx=S.data.map(d=>d.sid).lastIndexOf(sid);
  if(idx===-1){showToast('Sin datos para deshacer','warn');return;}
  const rm=S.data.splice(idx,1)[0];
  const s=S.series.find(s=>s.id===sid);
  rebuildLog();render();redraw();ctrlSync();
  showToast(`Deshecho: ${s?.name||'?'} ${fmt(rm.value)}`,'warn');
}
function clearSeries(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  askConfirm(
    `¬øLimpiar "${s.name}"?`,
    'Se eliminar√°n todos los puntos de esta serie. El cron√≥metro se reiniciar√°.',
    ()=>{
      S.data=S.data.filter(d=>d.sid!==sid);
      seriesResetTimer(s);
      rebuildLog();render();redraw();ctrlSync();
      showToast(`${s.name} limpiada`,'warn');
    }
  );
}
function exportSeries(sid){
  const s=S.series.find(s=>s.id===sid);if(!s)return;
  const pts=S.data.filter(d=>d.sid===sid);
  if(!pts.length){showToast('Sin datos para exportar','warn');return;}
  const rows=['tiempo_s,valor,hora'];
  pts.forEach(d=>rows.push(`${d.time},${d.value},${d.ts}`));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([rows.join('\n')],{type:'text/csv'}));
  a.download=`${s.name.replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();showToast(`${s.name} exportada`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const grid=document.getElementById('sgrid');
  const hint=document.getElementById('nohint');
  if(!grid)return;
  grid.innerHTML='';
  if(hint)hint.style.display=S.series.length?'none':'block';
  if(!S.series.length)return;

  const active=S.actOrder.map(id=>S.series.find(s=>s.id===id)).filter(Boolean);
  const inactive=S.series.filter(s=>!s.active);
  [...active,...inactive].forEach(s=>{
    const pts=S.data.filter(d=>d.sid===s.id).length;
    const oNum=s.active?S.actOrder.indexOf(s.id)+1:null;
    const msNow=s.elapsed+(s.t0!==null?performance.now()-s.t0:0);
    const div=document.createElement('div');
    div.className='sc'+(s.active?' active':'');
    div.id='sc-'+s.id;
    div.style.setProperty('--c',s.color);

    // SVG icons as strings
    const icoMic=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>`;
    const icoPause=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="6" width="4" height="12"/><rect x="14" y="6" width="4" height="12"/></svg>`;
    const icoUndo=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 10h10a8 8 0 0 1 0 16H3"/><polyline points="3 10 7 6 3 2"/></svg>`;
    const icoClear=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>`;
    const icoExport=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
    const icoReset=`‚Ü∫`;

    div.innerHTML=`
      <div class="sc-top" onclick="toggleActive('${s.id}')">
        <div class="sc-dot" style="background:${s.color}"></div>
        <div class="sc-name">${esc(s.name)}</div>
        ${s.active?`<div class="sc-order">#${oNum}</div>`:''}
        <div class="sc-badge">ACTIVA</div>
        <div class="sc-pts">${pts}pt</div>
        <div class="sc-timer" id="timer-${s.id}">${fmtMs(msNow)}</div>
        <button class="sc-del" onclick="event.stopPropagation();deleteSeries('${s.id}')" title="Eliminar serie">√ó</button>
      </div>
      <div class="sc-det">
        <div class="mic-row hidden" id="microw-${s.id}">
          <label>üéô Micro</label>
          <select class="mic-sel" id="micsel-${s.id}"
            onchange="(()=>{const x=S.series.find(s=>s.id==='${s.id}');if(x)x.micId=this.value;})()"></select>
        </div>
        <div class="sc-btmrow">
          <button class="recbtn${s.rec?' on':''}" id="recbtn-${s.id}" style="--c:${s.color}"
            onclick="toggleRec('${s.id}')">
            ${s.rec?icoPause+' Pausar':icoMic+' Grabar'}
          </button>
          <div class="mbars${s.rec?' on':''}" id="bars-${s.id}" style="--c:${s.color}">
            <div class="mb"></div><div class="mb"></div><div class="mb"></div>
            <div class="mb"></div><div class="mb"></div><div class="mb"></div>
          </div>
          <button class="sc-action" onclick="event.stopPropagation();resetSeriesTimer('${s.id}')" title="Resetear cron√≥metro">${icoReset}</button>
          <button class="sc-action" onclick="event.stopPropagation();undoSeries('${s.id}')" title="Deshacer √∫ltimo punto">${icoUndo}</button>
          <button class="sc-action danger" onclick="event.stopPropagation();clearSeries('${s.id}')" title="Limpiar serie">${icoClear}</button>
          <button class="sc-action export" onclick="event.stopPropagation();exportSeries('${s.id}')" title="Exportar serie CSV">${icoExport}</button>
        </div>
        <div class="sc-heard" id="heard-${s.id}">Di solo el n√∫mero‚Ä¶</div>
      </div>
    `;
    grid.appendChild(div);
  });
}

function updateRecBtn(sid){
  const s=S.series.find(s=>s.id===sid);
  const btn=document.getElementById('recbtn-'+sid);
  const bars=document.getElementById('bars-'+sid);
  if(!btn||!s)return;
  const icoMic=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>`;
  const icoPause=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="6" width="4" height="12"/><rect x="14" y="6" width="4" height="12"/></svg>`;
  btn.className='recbtn'+(s.rec?' on':'');
  btn.innerHTML=s.rec?icoPause+' Pausar':icoMic+' Grabar';
  if(bars)bars.classList.toggle('on',s.rec);
}
function setHeard(sid,text,mode){
  const el=document.getElementById('heard-'+sid);
  if(!el)return;
  el.textContent=text;el.className='sc-heard'+(mode?' '+mode:'');
}
function updateGlobal(){
  const anyRec=S.series.some(s=>s.rec);
  const actN=S.actOrder.length;
  const hdot=document.getElementById('hdot');
  const hstat=document.getElementById('hstatus');
  const apill=document.getElementById('apill');
  const acnt=document.getElementById('acnt');
  const stopb=document.getElementById('stopbtn');
  if(hdot)hdot.classList.toggle('live',anyRec);
  if(hstat)hstat.textContent=anyRec?'escuchando':'inactivo';
  if(apill)apill.style.display=actN>0?'flex':'none';
  if(acnt)acnt.textContent=actN;
  if(stopb)stopb.disabled=!anyRec;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLogRow(e){
  const s=S.series.find(s=>s.id===e.sid);
  const sc=document.getElementById('logscroll');
  if(!sc)return;
  const emp=sc.querySelector('.lempty');
  if(emp)emp.remove();
  const r=document.createElement('div');
  r.className='lrow fresh';
  r.style.setProperty('--lc',s?.color||'#fff');
  r.innerHTML=`
    <span class="lt">${e.ts}</span>
    <span class="lname" style="color:${s?.color||'var(--txt)'}">${esc(s?.name||'?')}</span>
    <span class="ltimer">${fmt(e.time)}s</span>
    <span class="lval">${fmt(e.value)}</span>
  `;
  sc.insertBefore(r,sc.firstChild);
  setTimeout(()=>r.classList.remove('fresh'),500);
  const lcnt=document.getElementById('lcnt');
  if(lcnt)lcnt.textContent=`(${S.data.length})`;
}
function rebuildLog(){
  const sc=document.getElementById('logscroll');
  if(!sc)return;
  sc.innerHTML='<div class="lempty">Sin datos todav√≠a</div>';
  const lcnt=document.getElementById('lcnt');
  if(!S.data.length){if(lcnt)lcnt.textContent='';return;}
  [...S.data].reverse().forEach(e=>addLogRow(e));
}
function ctrlSync(){
  const has=S.data.length>0;
  ['ebtn','ubtn','cbtn'].forEach(id=>{const el=document.getElementById(id);if(el)el.disabled=!has;});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHART  (catmull-rom spline with tension slider)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function catmullRom(ctx,pts,tension,sx,sy){
  if(pts.length<2){
    if(pts.length===1)ctx.lineTo(sx(pts[0].time),sy(pts[0].value));
    return;
  }
  ctx.moveTo(sx(pts[0].time),sy(pts[0].value));
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[Math.max(0,i-1)];
    const p1=pts[i];
    const p2=pts[i+1];
    const p3=pts[Math.min(pts.length-1,i+2)];
    const cp1x=sx(p1.time)+(sx(p2.time)-sx(p0.time))*tension/6;
    const cp1y=sy(p1.value)+(sy(p2.value)-sy(p0.value))*tension/6;
    const cp2x=sx(p2.time)-(sx(p3.time)-sx(p1.time))*tension/6;
    const cp2y=sy(p2.value)-(sy(p3.value)-sy(p1.value))*tension/6;
    ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,sx(p2.time),sy(p2.value));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAN / ZOOM ENGINE  (shared by all canvases)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Each chart keeps a viewport: {xLo,xHi,yLo,yHi}
// null ‚Üí auto-fit on next draw
const VP={main:null,reg:null,lag:null};

/* Compute auto-fit viewport from data extents */
function autoVP(xs,ys,padX=0.08,padY=0.18){
  const xMn=Math.min(...xs),xMx=Math.max(...xs);
  const yMn=Math.min(...ys),yMx=Math.max(...ys);
  const dx=(xMx-xMn)||1,dy=(yMx-yMn)||1;
  return{xLo:xMn-dx*padX,xHi:xMx+dx*padX,yLo:yMn-dy*padY,yHi:yMx+dy*padY};
}

/* Convert canvas pixel ‚Üí data coords given viewport + padding */
function px2data(px,py,vp,W,H,P){
  const cw=W-P.l-P.r,ch=H-P.t-P.b;
  const x=vp.xLo+(px-P.l)/cw*(vp.xHi-vp.xLo);
  const y=vp.yHi-(py-P.t)/ch*(vp.yHi-vp.yLo);
  return{x,y};
}

/* Zoom viewport around a data point by factor (>1 = zoom in) */
function zoomVP(vp,cx,cy,factor){
  const dx=(vp.xHi-vp.xLo)/factor;
  const dy=(vp.yHi-vp.yLo)/factor;
  return{xLo:cx-dx/2,xHi:cx+dx/2,yLo:cy-dy/2,yHi:cy+dy/2};
}

/* Pan viewport by pixel delta */
function panVP(vp,dpx,dpy,W,H,P){
  const cw=W-P.l-P.r,ch=H-P.t-P.b;
  const dx=dpx/cw*(vp.xHi-vp.xLo);
  const dy=dpy/ch*(vp.yHi-vp.yLo);
  return{xLo:vp.xLo-dx,xHi:vp.xHi-dx,yLo:vp.yLo+dy,yHi:vp.yHi+dy};
}

/* Attach unified mouse/touch/wheel listeners to a canvas */
function bindInteraction(cv,vpKey,onDraw,resetFn){
  let drag=null;          // {x,y} last pointer position in canvas coords
  let lastTouchDist=null; // for pinch
  let lastTouchMid=null;
  const DPR=()=>window.devicePixelRatio||1;
  const P={t:22,r:22,b:46,l:56};

  function canvasXY(e){
    const r=cv.getBoundingClientRect();
    return{x:e.clientX-r.left,y:e.clientY-r.top};
  }
  function touchMidDist(t){
    const a=t[0],b=t[1];
    const mx=(a.clientX+b.clientX)/2,my=(a.clientY+b.clientY)/2;
    const dist=Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY);
    const r=cv.getBoundingClientRect();
    return{mid:{x:mx-r.left,y:my-r.top},dist};
  }

  // ‚îÄ‚îÄ WHEEL (mouse scroll / trackpad pinch via ctrlKey) ‚îÄ‚îÄ
  cv.addEventListener('wheel',e=>{
    e.preventDefault();
    if(!VP[vpKey])return;
    const {x,y}=canvasXY(e);
    const W=cv.clientWidth,H=cv.clientHeight;
    const dc=px2data(x,y,VP[vpKey],W,H,P);
    // ctrlKey ‚Üí pinch-to-zoom from OS; otherwise scroll pan or zoom
    const isZoom=e.ctrlKey||e.metaKey||Math.abs(e.deltaY)>Math.abs(e.deltaX)&&!e.shiftKey&&e.deltaMode===0&&Math.abs(e.deltaY)>2;
    if(isZoom){
      const factor=e.deltaY<0?1.12:1/1.12;
      VP[vpKey]=zoomVP(VP[vpKey],dc.x,dc.y,factor);
    } else {
      // pan: shiftKey ‚Üí horizontal, otherwise vertical
      const dpx=e.shiftKey?e.deltaY:e.deltaX;
      const dpy=e.shiftKey?0:e.deltaY;
      VP[vpKey]=panVP(VP[vpKey],dpx,dpy,W,H,P);
    }
    onDraw();
  },{passive:false});

  // ‚îÄ‚îÄ MOUSE DRAG ‚îÄ‚îÄ
  cv.addEventListener('mousedown',e=>{
    if(e.button!==0)return;
    cv.style.cursor='grabbing';
    drag=canvasXY(e);
  });
  window.addEventListener('mousemove',e=>{
    if(!drag||!VP[vpKey])return;
    const pos=canvasXY(e);
    const W=cv.clientWidth,H=cv.clientHeight;
    VP[vpKey]=panVP(VP[vpKey],pos.x-drag.x,pos.y-drag.y,W,H,P);
    drag=pos;
    onDraw();
  });
  window.addEventListener('mouseup',()=>{drag=null;cv.style.cursor='grab';});
  cv.style.cursor='grab';

  // ‚îÄ‚îÄ DOUBLE-CLICK reset ‚îÄ‚îÄ
  cv.addEventListener('dblclick',()=>{VP[vpKey]=null;resetFn();});

  // ‚îÄ‚îÄ TOUCH ‚îÄ‚îÄ
  cv.addEventListener('touchstart',e=>{
    e.preventDefault();
    if(e.touches.length===1){
      drag={x:e.touches[0].clientX,y:e.touches[0].clientY};
      lastTouchDist=null;
    } else if(e.touches.length===2){
      drag=null;
      const td=touchMidDist(e.touches);
      lastTouchDist=td.dist;lastTouchMid=td.mid;
    }
  },{passive:false});
  cv.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(!VP[vpKey])return;
    const W=cv.clientWidth,H=cv.clientHeight;
    if(e.touches.length===1&&drag){
      const nx=e.touches[0].clientX,ny=e.touches[0].clientY;
      VP[vpKey]=panVP(VP[vpKey],nx-drag.x,ny-drag.y,W,H,P);
      drag={x:nx,y:ny};
      onDraw();
    } else if(e.touches.length===2&&lastTouchDist!==null){
      const td=touchMidDist(e.touches);
      const factor=td.dist/lastTouchDist;
      const r=cv.getBoundingClientRect();
      const dc=px2data(td.mid.x,td.mid.y,VP[vpKey],W,H,P);
      VP[vpKey]=zoomVP(VP[vpKey],dc.x,dc.y,factor);
      // also pan from mid movement
      VP[vpKey]=panVP(VP[vpKey],td.mid.x-lastTouchMid.x,td.mid.y-lastTouchMid.y,W,H,P);
      lastTouchDist=td.dist;lastTouchMid=td.mid;
      onDraw();
    }
  },{passive:false});
  cv.addEventListener('touchend',e=>{
    e.preventDefault();
    if(e.touches.length<2){lastTouchDist=null;}
    if(e.touches.length===0){drag=null;}
  },{passive:false});
}

/* Draw a nice grid with smart tick spacing */
function drawGrid(ctx,vp,P,cw,ch,fmtX,fmtY){
  const xRange=vp.xHi-vp.xLo,yRange=vp.yHi-vp.yLo;
  function niceStep(range,ticks){
    const raw=range/ticks;
    const mag=Math.pow(10,Math.floor(Math.log10(raw)));
    const norm=raw/mag;
    let step=norm<1.5?1:norm<3?2:norm<7?5:10;
    return step*mag;
  }
  const xStep=niceStep(xRange,6),yStep=niceStep(yRange,5);
  const sx=x=>P.l+(x-vp.xLo)/xRange*cw;
  const sy=y=>P.t+ch-(y-vp.yLo)/yRange*ch;

  ctx.strokeStyle='#1e2130';ctx.lineWidth=1;
  // X grid lines
  const x0=Math.ceil(vp.xLo/xStep)*xStep;
  for(let xv=x0;xv<=vp.xHi+xStep*0.01;xv+=xStep){
    const px=sx(xv);if(px<P.l-1||px>P.l+cw+1)continue;
    ctx.beginPath();ctx.moveTo(px,P.t);ctx.lineTo(px,P.t+ch);ctx.stroke();
  }
  // Y grid lines
  const y0=Math.ceil(vp.yLo/yStep)*yStep;
  for(let yv=y0;yv<=vp.yHi+yStep*0.01;yv+=yStep){
    const py=sy(yv);if(py<P.t-1||py>P.t+ch+1)continue;
    ctx.beginPath();ctx.moveTo(P.l,py);ctx.lineTo(P.l+cw,py);ctx.stroke();
  }
  // X labels
  ctx.font=`10px 'JetBrains Mono',monospace`;ctx.fillStyle='#52566a';ctx.textAlign='center';
  for(let xv=x0;xv<=vp.xHi+xStep*0.01;xv+=xStep){
    const px=sx(xv);if(px<P.l||px>P.l+cw)continue;
    ctx.fillText(fmtX(xv),px,P.t+ch+16);
  }
  // Y labels
  ctx.textAlign='right';
  for(let yv=y0;yv<=vp.yHi+yStep*0.01;yv+=yStep){
    const py=sy(yv);if(py<P.t||py>P.t+ch)continue;
    ctx.fillText(fmtY(yv),P.l-7,py+3.5);
  }
  return{sx,sy};
}

function redraw(){
  const cv=document.getElementById('chart');
  const emp=document.getElementById('cempty');
  const leg=document.getElementById('legend');
  const mt=document.getElementById('cmeta');
  if(!cv||!emp||!leg||!mt)return;

  if(!S.data.length){
    cv.style.display='none';emp.style.display='flex';
    leg.style.display='none';mt.textContent='0 puntos';
    VP.main=null;return;
  }
  cv.style.display='block';emp.style.display='none';leg.style.display='flex';
  const usedIds=[...new Set(S.data.map(d=>d.sid))];
  mt.textContent=`${S.data.length} pt ¬∑ ${usedIds.length} serie(s)  ¬∑ scroll/pellizco: zoom ¬∑ arrastrar: pan ¬∑ doble-clic: reset`;

  leg.innerHTML='';
  S.series.filter(s=>usedIds.includes(s.id)).forEach(s=>{
    const p=document.createElement('div');p.className='lpill';
    p.innerHTML=`<div class="ldot" style="background:${s.color}"></div>${esc(s.name)}`;
    leg.appendChild(p);
  });

  const W=cv.parentElement.offsetWidth,H=300,DPR=window.devicePixelRatio||1;
  cv.width=W*DPR;cv.height=H*DPR;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(DPR,DPR);

  const P={t:22,r:22,b:46,l:56};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;

  // Auto-fit viewport on first draw or after reset
  if(!VP.main){
    const allT=S.data.map(d=>d.time),allV=S.data.map(d=>d.value);
    VP.main=autoVP(allT,allV,0.06,0.18);
  }
  const vp=VP.main;
  const xRange=vp.xHi-vp.xLo,yRange=vp.yHi-vp.yLo;

  ctx.fillStyle='#13141a';rRect(ctx,P.l,P.t,cw,ch,10);ctx.fill();

  // clip to chart area
  ctx.save();ctx.beginPath();ctx.rect(P.l,P.t,cw,ch);ctx.clip();

  const {sx,sy}=drawGrid(ctx,vp,P,cw,ch,
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(xRange||1))))).toString(),
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(yRange||1))))).toString()
  );

  ctx.save();ctx.translate(16,P.t+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#3a3e52';ctx.font=`10px 'JetBrains Mono',monospace`;ctx.textAlign='center';
  ctx.fillText('VALOR',0,0);ctx.restore();

  const ten=S.tension;
  S.series.forEach(s=>{
    const pts=S.data.filter(d=>d.sid===s.id).sort((a,b)=>a.time-b.time);
    if(!pts.length)return;

    // area fill
    ctx.save();ctx.beginPath();
    ctx.moveTo(sx(pts[0].time),P.t+ch);
    catmullRom(ctx,pts,ten,sx,sy);
    ctx.lineTo(sx(pts[pts.length-1].time),P.t+ch);
    ctx.closePath();
    const g=ctx.createLinearGradient(0,P.t,0,P.t+ch);
    g.addColorStop(0,hexA(s.color,.18));g.addColorStop(1,hexA(s.color,0));
    ctx.fillStyle=g;ctx.fill();ctx.restore();

    // spline line
    ctx.beginPath();ctx.strokeStyle=s.color;ctx.lineWidth=2.4;
    ctx.lineJoin='round';ctx.lineCap='round';
    catmullRom(ctx,pts,ten,sx,sy);
    ctx.stroke();

    // dots + labels (only if not too zoomed-out)
    pts.forEach(p=>{
      const x=sx(p.time),y=sy(p.value);
      if(x<P.l-8||x>P.l+cw+8||y<P.t-8||y>P.t+ch+8)return;
      ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);
      ctx.fillStyle='#13141a';ctx.fill();
      ctx.strokeStyle=s.color;ctx.lineWidth=2.2;ctx.stroke();
      ctx.fillStyle=s.color;ctx.font=`bold 11px 'JetBrains Mono',monospace`;
      ctx.textAlign='center';ctx.fillText(fmt(p.value),x,y-12);
    });
  });
  ctx.restore();// unclip
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function undoLast(sid){
  // sid=null ‚Üí undo globally (any last point); sid ‚Üí undo last point of that series
  if(sid)return undoSeries(sid);
  if(!S.data.length)return;
  const rm=S.data.pop();
  const s=S.series.find(s=>s.id===rm.sid);
  rebuildLog();render();redraw();ctrlSync();
  showToast(`Deshecho: ${s?.name||'?'} ${fmt(rm.value)}`,'warn');
}
function askClear(sid){
  if(sid)return clearSeries(sid);
  askConfirm('¬øLimpiar todo?','Se eliminar√°n todos los puntos de todas las series.',()=>{
    S.data=[];S.series.forEach(s=>seriesResetTimer(s));
    VP.main=null;
    rebuildLog();render();redraw();ctrlSync();
    showToast('Todos los datos eliminados','warn');
  });
}
function exportCSV(sid){
  const pts=sid?S.data.filter(d=>d.sid===sid):S.data;
  if(!pts.length){showToast('Sin datos para exportar','warn');return;}
  const rows=['dato,serie,valor,hora'];
  pts.forEach(d=>{
    const s=S.series.find(s=>s.id===d.sid);
    rows.push(`${d.time},${s?.name||d.sid},${d.value},${d.ts}`);
  });
  const sname=sid?S.series.find(s=>s.id===sid)?.name.replace(/\s+/g,'_'):'todo';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([rows.join('\n')],{type:'text/csv'}));
  a.download=`voicechart_${sname}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();showToast('CSV descargado','ok');
}

// ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
    if(lines.length<2){showToast('CSV vac√≠o o inv√°lido','err');return;}
    const header=lines[0].toLowerCase();
    // Detect column indices
    const cols=header.split(',');
    const iTime=cols.findIndex(c=>c.includes('dato'));
    const iSerie=cols.findIndex(c=>c.includes('serie'));
    const iVal=cols.findIndex(c=>c.includes('valor'));
    if(iTime<0||iVal<0){showToast('CSV sin columnas dato/valor','err');return;}

    let added=0;
    const seriesMap={};  // name ‚Üí id (find existing or create)

    lines.slice(1).forEach(line=>{
      const parts=line.split(',');
      const time=parseFloat(parts[iTime]);
      const value=parseFloat(parts[iVal]);
      if(isNaN(time)||isNaN(value))return;
      const sname=(iSerie>=0&&parts[iSerie])?parts[iSerie].trim():'Importada';
      // Find or create series
      if(!seriesMap[sname]){
        let existing=S.series.find(s=>s.name===sname);
        if(!existing){
          const color=PALETTE[S.series.length%PALETTE.length];
          S.series.push({id:'s'+Date.now()+'_'+Math.random(),name:sname,color,
            active:false,activatedAt:0,micId:'default',rec:false,recObj:null,t0:null,elapsed:0});
          existing=S.series[S.series.length-1];
        }
        seriesMap[sname]=existing.id;
      }
      const sid=seriesMap[sname];
      const ts=parts[3]||new Date().toLocaleTimeString('es-ES',{hour12:false});
      S.data.push({sid,time,value,ts});
      added++;
    });

    // Sort data by time per series
    S.data.sort((a,b)=>a.time-b.time);
    rebuildLog();render();redraw();ctrlSync();
    showToast(`${added} puntos importados`,'ok');
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function askConfirm(title,body,onConfirm){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').textContent=body;
  modalConfirmCb=()=>{closeModal();onConfirm();};
  document.getElementById('mbg').classList.add('show');
}
function closeModal(){
  document.getElementById('mbg').classList.remove('show');
  modalConfirmCb=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmt(v){if(v==null)return'';return Number.isInteger(v)?String(v):Number(v.toFixed(2)).toString();}
function hexA(h,a){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;}
function rRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANALYSIS ‚Äî TAB SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function anlTab(id){
  ['reg','lagrange'].forEach(t=>{
    document.getElementById('tab-'+t)?.classList.toggle('sel',t===id);
    document.getElementById('pane-'+t)?.classList.toggle('vis',t===id);
  });
  refreshAnlSelects();
}
function refreshAnlSelects(){
  const ids=['reg-series','lag-series'];
  ids.forEach(selId=>{
    const sel=document.getElementById(selId);
    if(!sel)return;
    const prev=sel.value;
    sel.innerHTML=S.series.filter(s=>S.data.some(d=>d.sid===s.id))
      .map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join('');
    if(prev&&[...sel.options].some(o=>o.value===prev))sel.value=prev;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATH HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPts(sid){
  return S.data.filter(d=>d.sid===sid).map(d=>({x:d.time,y:d.value})).sort((a,b)=>a.x-b.x);
}
function fmtC(v,prec=4){
  if(isNaN(v)||!isFinite(v))return'?';
  return Number(v.toFixed(prec)).toString();
}
function R2(pts,fn){
  const yMean=pts.reduce((s,p)=>s+p.y,0)/pts.length;
  const ss_tot=pts.reduce((s,p)=>s+(p.y-yMean)**2,0);
  const ss_res=pts.reduce((s,p)=>s+(p.y-fn(p.x))**2,0);
  return ss_tot===0?1:1-ss_res/ss_tot;
}
function RMSE(pts,fn){
  return Math.sqrt(pts.reduce((s,p)=>s+(p.y-fn(p.x))**2,0)/pts.length);
}
function metric(lbl,val,accent=''){
  return`<div class="anl-metric"><div class="anl-metric-lbl">${lbl}</div><div class="anl-metric-val" style="${accent?'color:'+accent:''}">${val}</div></div>`;
}

// ‚îÄ‚îÄ LEAST SQUARES: solve Ax=b via Gaussian elimination ‚îÄ‚îÄ
function solveLS(A,b){
  const n=A.length;
  const M=A.map((r,i)=>[...r,b[i]]);
  for(let col=0;col<n;col++){
    let maxR=col;
    for(let r=col+1;r<n;r++)if(Math.abs(M[r][col])>Math.abs(M[maxR][col]))maxR=r;
    [M[col],M[maxR]]=[M[maxR],M[col]];
    if(Math.abs(M[col][col])<1e-14)return null;
    for(let r=0;r<n;r++)if(r!==col){
      const f=M[r][col]/M[col][col];
      for(let c=col;c<=n;c++)M[r][c]-=f*M[col][c];
    }
  }
  return M.map((r,i)=>r[n]/r[i]);
}

// ‚îÄ‚îÄ POLYNOMIAL REGRESSION (degree d) ‚îÄ‚îÄ
function polyReg(pts,d){
  const n=d+1;
  const A=Array.from({length:n},(_,r)=>Array.from({length:n},(_,c)=>pts.reduce((s,p)=>s+Math.pow(p.x,r+c),0)));
  const b=Array.from({length:n},(_,r)=>pts.reduce((s,p)=>s+Math.pow(p.x,r)*p.y,0));
  return solveLS(A,b);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REGRESSION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _lastReg=null;

function runRegression(){
  refreshAnlSelects();
  const sid=document.getElementById('reg-series')?.value;
  const type=document.getElementById('reg-type')?.value;
  if(!sid){showToast('No hay series con datos','warn');return;}
  const pts=getPts(sid);
  const s=S.series.find(s=>s.id===sid);

  let fn,eqStr,ok=true,warn='';

  if(type==='linear'){
    const c=polyReg(pts,1);
    if(!c){ok=false;}else{
      fn=x=>c[0]+c[1]*x;
      eqStr=`y = ${fmtC(c[1])}¬∑x + ${fmtC(c[0])}`;
    }
  } else if(type==='poly2'){
    if(pts.length<3){showToast('Se necesitan ‚â•3 puntos para grado 2','warn');return;}
    const c=polyReg(pts,2);
    if(!c){ok=false;}else{
      fn=x=>c[0]+c[1]*x+c[2]*x*x;
      eqStr=`y = ${fmtC(c[2])}¬∑x¬≤ + ${fmtC(c[1])}¬∑x + ${fmtC(c[0])}`;
    }
  } else if(type==='poly3'){
    if(pts.length<4){showToast('Se necesitan ‚â•4 puntos para grado 3','warn');return;}
    const c=polyReg(pts,3);
    if(!c){ok=false;}else{
      fn=x=>c[0]+c[1]*x+c[2]*x*x+c[3]*x*x*x;
      eqStr=`y = ${fmtC(c[3])}¬∑x¬≥ + ${fmtC(c[2])}¬∑x¬≤ + ${fmtC(c[1])}¬∑x + ${fmtC(c[0])}`;
    }
  } else if(type==='exp'){
    const pos=pts.filter(p=>p.y>0);
    if(pos.length<pts.length)warn='‚ö† Se ignoraron puntos con y‚â§0';
    if(pos.length<2){showToast('Se necesitan ‚â•2 puntos y>0 para exponencial','warn');return;}
    const lnPts=pos.map(p=>({x:p.x,y:Math.log(p.y)}));
    const c=polyReg(lnPts,1);
    if(!c){ok=false;}else{
      const a=Math.exp(c[0]),b=c[1];
      fn=x=>a*Math.exp(b*x);
      eqStr=`y = ${fmtC(a)}¬∑e^(${fmtC(b)}¬∑x)`;
    }
  } else if(type==='log'){
    const pos=pts.filter(p=>p.x>0);
    if(pos.length<pts.length)warn='‚ö† Se ignoraron puntos con x‚â§0';
    if(pos.length<2){showToast('Se necesitan ‚â•2 puntos x>0 para logar√≠tmica','warn');return;}
    const lnPts=pos.map(p=>({x:Math.log(p.x),y:p.y}));
    const c=polyReg(lnPts,1);
    if(!c){ok=false;}else{
      fn=x=>c[0]+c[1]*Math.log(x);
      eqStr=`y = ${fmtC(c[1])}¬∑ln(x) + ${fmtC(c[0])}`;
    }
  } else if(type==='power'){
    const pos=pts.filter(p=>p.x>0&&p.y>0);
    if(pos.length<pts.length)warn='‚ö† Se ignoraron puntos con x‚â§0 o y‚â§0';
    if(pos.length<2){showToast('Se necesitan ‚â•2 puntos x,y>0 para potencial','warn');return;}
    const lnPts=pos.map(p=>({x:Math.log(p.x),y:Math.log(p.y)}));
    const c=polyReg(lnPts,1);
    if(!c){ok=false;}else{
      const a=Math.exp(c[0]),b=c[1];
      fn=x=>a*Math.pow(x,b);
      eqStr=`y = ${fmtC(a)}¬∑x^${fmtC(b)}`;
    }
  }

  if(!ok){showToast('El sistema no pudo resolverse','err');return;}

  const r2=R2(pts,fn);
  const rmse=RMSE(pts,fn);

  document.getElementById('reg-eq').textContent=eqStr;
  document.getElementById('reg-metrics').innerHTML=
    metric('R¬≤',fmtC(r2,4),r2>0.95?'#4ade80':r2>0.8?'#facc15':'#f87171')+
    metric('RMSE',fmtC(rmse,4))+
    metric('Puntos',pts.length);
  document.getElementById('reg-note').textContent=warn||`${pts.length} puntos ‚Äî Serie: ${s?.name||''}`;
  document.getElementById('reg-results').classList.add('vis');

  _lastReg={pts,fn,type,s};
  VP.reg=null; // reset viewport for new regression
  drawRegChart(pts,fn,s?.color||'#38bdf8');
  // bind interaction once (idempotent guard)
  const cv=document.getElementById('anlChart');
  if(cv&&!cv._intBound){
    cv._intBound=true;
    bindInteraction(cv,'reg',()=>{if(_lastReg)drawRegChart(_lastReg.pts,_lastReg.fn,_lastReg.s?.color||'#38bdf8');},()=>{if(_lastReg)drawRegChart(_lastReg.pts,_lastReg.fn,_lastReg.s?.color||'#38bdf8');});
  }
  showToast('Regresi√≥n calculada','ok');
}

function drawRegChart(pts,fn,color){
  const cv=document.getElementById('anlChart');
  if(!cv)return;
  const W=cv.parentElement.offsetWidth,H=220,DPR=window.devicePixelRatio||1;
  cv.width=W*DPR;cv.height=H*DPR;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(DPR,DPR);

  const P={t:16,r:16,b:36,l:52};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;

  // Auto-fit
  if(!VP.reg){
    const allX=pts.map(p=>p.x),allY=pts.map(p=>p.y);
    const xMn=Math.min(...allX),xMx=Math.max(...allX),xR=(xMx-xMn)||1;
    const fYs=Array.from({length:60},(_,i)=>fn(xMn+(xR/59)*i)).filter(isFinite);
    VP.reg=autoVP(allX,[...allY,...fYs],0.08,0.15);
  }
  const vp=VP.reg;
  const xRange=vp.xHi-vp.xLo,yRange=vp.yHi-vp.yLo;

  ctx.fillStyle='#13141a';rRect(ctx,P.l,P.t,cw,ch,8);ctx.fill();
  ctx.save();ctx.beginPath();ctx.rect(P.l,P.t,cw,ch);ctx.clip();

  const {sx,sy}=drawGrid(ctx,vp,P,cw,ch,
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(xRange||1))))).toString(),
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(yRange||1))))).toString()
  );

  // regression curve
  ctx.beginPath();ctx.strokeStyle='#38bdf8';ctx.lineWidth=2;ctx.setLineDash([]);
  const xMn2=vp.xLo,xMx2=vp.xHi;
  const steps=300;
  let first=true;
  for(let i=0;i<=steps;i++){
    const x=xMn2+(xMx2-xMn2)/steps*i,y=fn(x);
    if(!isFinite(y)){first=true;continue;}
    first?(ctx.moveTo(sx(x),sy(y)),first=false):ctx.lineTo(sx(x),sy(y));
  }
  ctx.stroke();

  // data points
  pts.forEach(p=>{
    const x=sx(p.x),y=sy(p.y);
    ctx.beginPath();ctx.arc(x,y,4.5,0,Math.PI*2);
    ctx.fillStyle='#13141a';ctx.fill();
    ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();
  });
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LAGRANGE INTERPOLATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _lagPts=null;

function lagrangeEval(pts,x){
  let result=0;
  for(let i=0;i<pts.length;i++){
    let term=pts[i].y;
    for(let j=0;j<pts.length;j++){
      if(j!==i)term*=(x-pts[j].x)/(pts[i].x-pts[j].x);
    }
    result+=term;
  }
  return result;
}

function lagrangeTerm(pts,i){
  // Returns string representation of the i-th basis polynomial * pts[i].y
  const xi=pts[i].x;
  let numParts=[],denParts=[];
  for(let j=0;j<pts.length;j++){
    if(j===i)continue;
    numParts.push(`(x - ${fmtC(pts[j].x,3)})`);
    denParts.push(`(${fmtC(xi,3)} - ${fmtC(pts[j].x,3)})`);
  }
  const den=denParts.reduce((acc,_,idx)=>{
    const vals=pts.filter((_,j)=>j!==i).map(p=>pts[i].x-p.x);
    return vals.reduce((a,b)=>a*b,1);
  },1);
  // compute denominator numerically
  const denomVal=pts.filter((_,j)=>j!==i).reduce((acc,p)=>acc*(xi-p.x),1);
  const coeff=pts[i].y/denomVal;
  return{coeff,numParts,denomVal,yi:pts[i].y};
}

function buildLagrangeEqStr(pts){
  if(pts.length===1)return`P(x) = ${fmtC(pts[0].y,4)}`;
  if(pts.length>8)return`P(x) = polinomio de grado ${pts.length-1} (${pts.length} nodos)`;
  const terms=pts.map((p,i)=>{
    const denomVal=pts.filter((_,j)=>j!==i).reduce((acc,q)=>acc*(p.x-q.x),1);
    const coeff=p.y/denomVal;
    const numStr=pts.filter((_,j)=>j!==i).map(q=>`(x-${fmtC(q.x,2)})`).join('¬∑');
    return`${fmtC(coeff,3)}¬∑${numStr}`;
  });
  return`P(x) = ${terms.join(' + ')}`;
}

function runLagrange(){
  refreshAnlSelects();
  const sid=document.getElementById('lag-series')?.value;
  if(!sid){showToast('No hay series con datos','warn');return;}
  const pts=getPts(sid);
  const s=S.series.find(s=>s.id===sid);

  // check for duplicate x values
  const xs=pts.map(p=>p.x);
  const unique=new Set(xs.map(v=>Math.round(v*1e10)));
  if(unique.size<xs.length){showToast('Hay valores x duplicados ‚Äî imposible interpolar','err');return;}

  _lagPts=pts;
  document.getElementById('lag-eq').textContent=buildLagrangeEqStr(pts);

  const r2=R2(pts,x=>lagrangeEval(pts,x));
  document.getElementById('lag-metrics').innerHTML=
    metric('Grado',pts.length-1)+
    metric('Nodos',pts.length)+
    metric('R¬≤ (datos)',fmtC(r2,4),'#4ade80');

  document.getElementById('lag-results').classList.add('vis');
  document.getElementById('lag-result').classList.remove('vis');
  VP.lag=null; // reset viewport for new interpolation
  drawLagrangeChart(pts,s?.color||'#a78bfa');
  // bind interaction once
  const lcv=document.getElementById('lagChart');
  if(lcv&&!lcv._intBound){
    lcv._intBound=true;
    bindInteraction(lcv,'lag',()=>{if(_lagPts){const ls=S.series.find(s=>_lagPts.some(p=>S.data.find(d=>d.sid===s.id&&d.time===p.x)));drawLagrangeChart(_lagPts,ls?.color||'#a78bfa');}},()=>{if(_lagPts){const ls=S.series.find(s=>_lagPts.some(p=>S.data.find(d=>d.sid===s.id&&d.time===p.x)));drawLagrangeChart(_lagPts,ls?.color||'#a78bfa');}});
  }
  showToast('Interpolaci√≥n calculada','ok');
}

function evalLagrange(){
  if(!_lagPts){showToast('Calcula primero la interpolaci√≥n','warn');return;}
  const xv=parseFloat(document.getElementById('lag-x')?.value);
  if(isNaN(xv)){showToast('Ingresa un valor de x v√°lido','warn');return;}
  const yv=lagrangeEval(_lagPts,xv);
  const el=document.getElementById('lag-result');
  el.textContent=`P(${fmtC(xv,4)}) = ${fmtC(yv,6)}`;
  el.classList.add('vis');
  // re-draw keeping current viewport (don't reset VP.lag)
  const s=S.series.find(s=>_lagPts.some(p=>S.data.find(d=>d.sid===s.id&&d.time===p.x)));
  drawLagrangeChart(_lagPts,s?.color||'#a78bfa',{x:xv,y:yv});
}

function drawLagrangeChart(pts,color,evalPt=null){
  const cv=document.getElementById('lagChart');
  if(!cv)return;
  const W=cv.parentElement.offsetWidth,H=220,DPR=window.devicePixelRatio||1;
  cv.width=W*DPR;cv.height=H*DPR;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(DPR,DPR);

  const P={t:16,r:16,b:36,l:52};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;

  // Auto-fit (include evalPt if present)
  if(!VP.lag){
    const allX=pts.map(p=>p.x);
    const xMn=Math.min(...allX),xMx=Math.max(...allX);
    const xPad=(xMx-xMn||1)*.15;
    const xLo2=xMn-xPad,xHi2=xMx+xPad;
    const steps2=200;
    const curveY2=Array.from({length:steps2+1},(_,i)=>lagrangeEval(pts,xLo2+(xHi2-xLo2)/steps2*i));
    const allY2=[...pts.map(p=>p.y),...curveY2.filter(v=>isFinite(v)&&Math.abs(v)<1e8)];
    if(evalPt)allY2.push(evalPt.y);
    VP.lag=autoVP(allX,allY2,0.15,0.15);
  }
  const vp=VP.lag;
  const xRange=vp.xHi-vp.xLo,yRange=vp.yHi-vp.yLo;

  ctx.fillStyle='#13141a';rRect(ctx,P.l,P.t,cw,ch,8);ctx.fill();
  ctx.save();ctx.beginPath();ctx.rect(P.l,P.t,cw,ch);ctx.clip();

  const {sx,sy}=drawGrid(ctx,vp,P,cw,ch,
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(xRange||1))))).toString(),
    v=>Number(v.toFixed(Math.max(0,2-Math.floor(Math.log10(yRange||1))))).toString()
  );

  // interpolation curve
  const steps=300;
  const grad=ctx.createLinearGradient(P.l,0,P.l+cw,0);
  grad.addColorStop(0,'#a78bfa');grad.addColorStop(1,'#38bdf8');
  ctx.beginPath();ctx.strokeStyle=grad;ctx.lineWidth=2;ctx.setLineDash([]);
  let fst=true;
  for(let i=0;i<=steps;i++){
    const xv=vp.xLo+(vp.xHi-vp.xLo)/steps*i;
    const yv=lagrangeEval(pts,xv);
    if(!isFinite(yv)||Math.abs(yv)>1e8){fst=true;continue;}
    fst?(ctx.moveTo(sx(xv),sy(yv)),fst=false):ctx.lineTo(sx(xv),sy(yv));
  }
  ctx.stroke();

  // data nodes
  pts.forEach(p=>{
    const x=sx(p.x),y=sy(p.y);
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);
    ctx.fillStyle='#13141a';ctx.fill();
    ctx.strokeStyle=color;ctx.lineWidth=2.2;ctx.stroke();
    ctx.fillStyle=color;ctx.font=`bold 10px 'JetBrains Mono',monospace`;
    ctx.textAlign='center';ctx.fillText(fmtC(p.y,2),x,y-12);
  });

  // eval marker
  if(evalPt&&isFinite(evalPt.y)&&Math.abs(evalPt.y)<1e8){
    const ex=sx(evalPt.x),ey=sy(evalPt.y);
    ctx.strokeStyle='rgba(167,139,250,.5)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(ex,P.t);ctx.lineTo(ex,P.t+ch);ctx.stroke();
    ctx.beginPath();ctx.moveTo(P.l,ey);ctx.lineTo(P.l+cw,ey);ctx.stroke();
    ctx.setLineDash([]);
    ctx.beginPath();ctx.arc(ex,ey,6,0,Math.PI*2);
    ctx.fillStyle='#a78bfa';ctx.fill();
    ctx.strokeStyle='#13141a';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#a78bfa';ctx.font=`bold 11px 'JetBrains Mono',monospace`;
    const lx=ex+10;
    ctx.textAlign='left';
    ctx.fillText(fmtC(evalPt.y,4),lx,ey-10);
  }
  ctx.restore();
}

// Hook: refresh selects whenever data changes
const _origRecord=record;
// We patch redraw to also refresh selects
const _origRedraw=redraw;
function redraw(){_origRedraw();refreshAnlSelects();}

let _tt;
function showToast(msg,type=''){
  const el=document.getElementById('toast');if(!el)return;
  el.textContent=msg;el.className=`toast show ${type}`;
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2700);
}
function advancePalette(){
  palIdx=(palIdx+1)%PALETTE.length;
  const c=PALETTE[palIdx];
  const ci=document.getElementById('nscolor');
  const cb=document.getElementById('clrbtn');
  if(ci){try{ci.value=c;}catch(_){}}
  if(cb){try{cb.style.background=c;}catch(_){}}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  // Color picker sync
  const nscolor=document.getElementById('nscolor');
  const clrbtn=document.getElementById('clrbtn');
  if(nscolor&&clrbtn){
    nscolor.addEventListener('input',()=>{clrbtn.style.background=nscolor.value;});
  }

  // Tension slider
  const slider=document.getElementById('tension');
  const tval=document.getElementById('tensionVal');
  if(slider&&tval){
    slider.addEventListener('input',()=>{
      S.tension=parseFloat(slider.value);
      tval.textContent=slider.value;
      if(S.data.length)redraw();
    });
  }

  // CSV import
  const csvInput=document.getElementById('csvImport');
  if(csvInput){
    csvInput.addEventListener('change',e=>{
      if(e.target.files[0])importCSV(e.target.files[0]);
      e.target.value='';
    });
  }

  // No speech recognition warning
  if(!SR){
    const hdot=document.getElementById('hdot');
    const hst=document.getElementById('hstatus');
    if(hdot){hdot.style.background='#f87171';hdot.classList.remove('live');}
    if(hst)hst.textContent='no soportado';
  }

  // Default series
  addSeries('Serie A','#4ade80');
  addSeries('Serie B','#a78bfa');
  advancePalette();

  enumMics();
  navigator.mediaDevices?.addEventListener('devicechange',enumMics);
  window.addEventListener('resize',()=>{if(S.data.length)redraw();});

  // Bind pan/zoom to main chart
  const mainCv=document.getElementById('chart');
  if(mainCv){
    bindInteraction(mainCv,'main',
      ()=>{if(S.data.length)redraw();},
      ()=>{VP.main=null;if(S.data.length)redraw();}
    );
  }
});
</script>
</body>
</html>